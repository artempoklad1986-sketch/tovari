<?php
mb_internal_encoding('UTF-8');
date_default_timezone_set('Europe/Moscow');
session_start();

/* Paths */
$BASE = __DIR__;
$uploadsDir = $BASE.'/uploads';
$ordersLog  = $BASE.'/orders.txt';
$configFile = $BASE.'/config.json';
$chatLog = $BASE.'/chat_log.txt';
$aiKnowledgeFile = $BASE.'/ai_knowledge.json';

/* FS init */
if (!is_dir($uploadsDir)) @mkdir($uploadsDir, 0775, true);
if (!file_exists($uploadsDir.'/.htaccess')) {
  @file_put_contents($uploadsDir.'/.htaccess', 'php_flag engine off\nOptions -ExecCGI\n<FilesMatch \'\\.(php|phar|phtml|cgi|pl|py)$\'>\nDeny from all\n</FilesMatch>\n');
}
if (!file_exists($ordersLog)) @file_put_contents($ordersLog, '');
if (!file_exists($chatLog)) @file_put_contents($chatLog, '');

/* AI Knowledge Base */
$defaultKnowledge = [
  'greetings' => [
    '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –¥–µ–¥—É—à–∫–∞ –ê—Ä—Ç–µ–º–∏–π, –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –≤ –º–∏—Ä–µ –ø–µ—á–∞—Ç–∏! üëã',
    '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê—Ä—Ç–µ–º–∏–π, —è –ø–æ–º–æ–≥—É –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –ø–µ—á–∞—Ç–∏! üìù',
    '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –ê—Ä—Ç–µ–º–∏–π, –º–∞—Å—Ç–µ—Ä –ø–µ—á–∞—Ç–Ω—ã—Ö –¥–µ–ª —Å 40-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º! üéØ'
  ],
  'services' => [
    '—Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã' => '–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–µ–ª–∞–µ–º –∑–∞ 5 –º–∏–Ω—É—Ç! –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–∞–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –¶–µ–Ω–∞ –≤—Å–µ–≥–æ 400 —Ä—É–±–ª–µ–π.',
    '–≤–∏–∑–∏—Ç–∫–∏' => '–í–∏–∑–∏—Ç–∫–∏ –ø–µ—á–∞—Ç–∞–µ–º –Ω–∞ –º–µ–ª–æ–≤–∞–Ω–Ω–æ–π –±—É–º–∞–≥–µ 300 –≥/–º¬≤. –ì–æ—Ç–æ–≤—ã –∑–∞ 1 –¥–µ–Ω—å. –û—Ç 900 —Ä—É–±–ª–µ–π –∑–∞ 100 —à—Ç—É–∫.',
    '–±–∞–Ω–Ω–µ—Ä—ã' => '–ë–∞–Ω–Ω–µ—Ä—ã –∏–∑ –ü–í–• 440 –≥/–º¬≤ —Å –ª—é–≤–µ—Ä—Å–∞–º–∏. –°—Ä–æ—á–Ω–æ–µ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ 2-4 —á–∞—Å–∞. –û—Ç 1100 —Ä—É–±–ª–µ–π.',
    '–ª–∏—Å—Ç–æ–≤–∫–∏' => '–õ–∏—Å—Ç–æ–≤–∫–∏ –ê6/–ê5/–ê4, –æ–¥–Ω–æ- –∏ –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ. –¢–∏—Ä–∞–∂ –æ—Ç 100 —à—Ç—É–∫. –°—Ä–æ–∫ 1-2 –¥–Ω—è.',
    '—à—Ç–∞–º–ø—ã' => '–®—Ç–∞–º–ø—ã –∏ –ø–µ—á–∞—Ç–∏ –∏–∑–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞! –û—Ç 1800 —Ä—É–±–ª–µ–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Å–Ω–∞—Å—Ç–∫–æ–π.'
  ],
  'prices' => [
    '—Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã' => '400 —Ä—É–±–ª–µ–π –∑–∞ —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã',
    '—Ä–∞—Å–ø–µ—á–∞—Ç–∫–∞' => '–æ—Ç 20 —Ä—É–±–ª–µ–π –∑–∞ –ª–∏—Å—Ç',
    '–≤–∏–∑–∏—Ç–∫–∏' => '–æ—Ç 900 —Ä—É–±–ª–µ–π –∑–∞ 100 —à—Ç—É–∫',
    '–±–∞–Ω–Ω–µ—Ä—ã' => '–æ—Ç 1100 —Ä—É–±–ª–µ–π',
    '—Ñ–æ—Ç–æ–ø–µ—á–∞—Ç—å' => '–æ—Ç 30 —Ä—É–±–ª–µ–π –∑–∞ —Ñ–æ—Ç–æ'
  ],
  'help' => [
    '–ú–æ–≥—É –ø–æ–º–æ—á—å –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É, —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å, –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –Ω–∞—à–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö!',
    '–°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –æ–±–æ –≤—Å–µ–º! –ó–Ω–∞—é –≤—Å–µ —Ç–æ–Ω–∫–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–Ω–æ–≥–æ –¥–µ–ª–∞ –∏ —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–¥–µ–ª—é—Å—å –æ–ø—ã—Ç–æ–º!',
    '–ü–æ–¥—Å–∫–∞–∂—É –ª—É—á—à–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª, –ø–æ—Å—á–∏—Ç–∞—é —Ü–µ–Ω—É –∏ –ø–æ–º–æ–≥—É —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞!'
  ]
];

if (!file_exists($aiKnowledgeFile)) @file_put_contents($aiKnowledgeFile, json_encode($defaultKnowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

/* Config */
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https://' : 'http://';
$siteURL = $scheme.$host;

$defaultConfig = [
  'brand'         => '–ö–æ–ø–∏—Ä–æ–≤–∞–ª—å–Ω—ã–π —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä –ü–†–ò–ù–¢–°–°',
  'slogan'        => '–ü–µ—á–∞—Ç—å –≤ –°–æ—Å–Ω–æ–≤–æ–º –ë–æ—Ä—É ‚Äî —É–ª. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49 (—Ä—è–¥–æ–º —Å OZON –∏ –°–∞—à–∞ –°—É—à–∏)',
  'hero'          => '–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî 5 –º–∏–Ω—É—Ç (—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –≤–∏–¥ –±–µ—Å–ø–ª–∞—Ç–Ω–æ)',
  'phone_display' => '+7 (952) 200-39-90',
  'phone_raw'     => '+79522003990',
  'email_to'      => 'artcopy78@bk.ru',
  'email_from'    => 'noreply@'.preg_replace('~^www\.~','',$host),
  'email_cc'      => '',
  'email_bcc'     => '',
  'email_reply'   => '',
  'address'       => '–†–æ—Å—Å–∏—è, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª., –°–æ—Å–Ω–æ–≤—ã–π –ë–æ—Ä, —É–ª. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49',
  'workhours'     => ['–ü–Ω‚Äì–ü—Ç 10:00‚Äì20:00', '–°–±‚Äì–í—Å 11:00‚Äì18:00'],
  'site'          => $siteURL,
  'logo'          => '',
  'hero_mode'     => 'svg',
  'hero_image'    => '',
  'catalog_desc'  => '–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥ –Ω–∞—à–µ–π —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏ –∏ —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä–∞. –ë—ã—Å—Ç—Ä–æ, —Ä—è–¥–æ–º, –ø–æ-—á–µ—Å—Ç–Ω—ã–º —Ü–µ–Ω–∞–º. –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–∫–∞–∑–∞—Ç—å¬ª –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –æ–Ω–ª–∞–π–Ω-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º.',
  'seo' => [
    'title'       => '–ö–æ–ø–∏—Ä–æ–≤–∞–ª—å–Ω—ã–π —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä –ü–†–ò–ù–¢–°–° ‚Äî —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è | –§–æ—Ç–æ 5 –º–∏–Ω—É—Ç',
    'description' => '–¢–∏–ø–æ–≥—Ä–∞—Ñ–∏—è –∏ —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä: –≤–∏–∑–∏—Ç–∫–∏, –±–∞–Ω–Ω–µ—Ä—ã, –ª–∏—Å—Ç–æ–≤–∫–∏, —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã 5 –º–∏–Ω—É—Ç. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49. –¢–µ–ª. +7 (952) 200-39-90',
    'keywords'    => '–ø–µ—á–∞—Ç—å, —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è, —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä, –≤–∏–∑–∏—Ç–∫–∏, –±–∞–Ω–Ω–µ—Ä—ã, —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –°–æ—Å–Ω–æ–≤—ã–π –ë–æ—Ä',
    'og_image'    => '',
    'sitemap_enable' => true,
  ],
  'business' => [
    'show_requisites' => true,
    'show_payment_icons' => true,
    'legal_name' => '–ò–ü –ì—É—Ä–±–∞–Ω–æ–≤–∞ –ì–∞–ª–∏–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞',
    'inn' => '',
    'ogrn' => '',
    'bank' => '',
    'bik' => '',
    'account' => '',
  ],
  'yukassa' => [
    'enabled'  => true,
    'shop_id'  => '',
    'secret_key' => '',
    'test_mode' => true,
    'return_url' => $siteURL . '/payment_result.php',
  ],
  'theme' => [
    'mode'         => 'light',
    'bg'           => '#f3f7ff',
    'text'         => '#0e1220',
    'muted'        => '#5c6b84',
    'brand'        => '#FF8A00',
    'accent'       => '#2D5BFF',
    'card_opacity' => 0.65,
    'blur'         => 12,
    'radius'       => 16,
    'shadow'       => 0.12,
    'container'    => 1200
  ],
  'telegram'      => [
    'enabled' => true,
    'token'   => '8385005974:AAHhQkvdKP5LJSbSI-pge_TGefgcYDLTBZw',
    'chat'    => ''
  ],
  'smtp' => [
    'enabled' => false,
    'host'    => 'smtp.mail.ru',
    'port'    => 465,
    'secure'  => 'ssl',
    'user'    => 'artcopy78@bk.ru',
    'pass'    => ''
  ],
  'admin_pass' => 'printss49',
  'features' => [
    'reviews_enabled' => true,
    'callback_widget' => true,
    'price_alerts' => true,
    'loyalty_program' => false,
  ],
  'social' => [
    'vk' => '',
    'instagram' => '',
    'youtube' => '',
    'whatsapp' => '+79522003990',
    'telegram_channel' => '',
  ]
];

if (!file_exists($configFile)) @file_put_contents($configFile, json_encode($defaultConfig, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
$cfg = json_decode(@file_get_contents($configFile), true);
if (!is_array($cfg)) $cfg = $defaultConfig;
$cfg = array_replace_recursive($defaultConfig, $cfg);

/* Helpers */
function esc($s){ return htmlspecialchars((string)$s, ENT_QUOTES|ENT_SUBSTITUTE, 'UTF-8'); }
function sanitize_text($s){ return trim(filter_var($s, FILTER_SANITIZE_FULL_SPECIAL_CHARS)); }
function sanitize_hex($s){ $s=trim((string)$s); if($s==='') return ''; if($s[0]!=='#') $s='#'.$s; if(!preg_match('~^#[0-9a-fA-F]{3,8}$~',$s)) return '#000000'; return $s; }
function clamp_float($v,$min,$max,$def){ $v=(float)$v; if(!is_finite($v)) return $def; return max($min, min($max, $v)); }
function clamp_int($v,$min,$max,$def){ $v=(int)$v; if(!is_finite($v)) return $def; return max($min, min($max, $v)); }
function log_order($path, $data){
  @file_put_contents($path, '['.date('Y-m-d H:i:s').'] '.json_encode($data, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);
}
function log_chat($path, $data){
  @file_put_contents($path, '['.date('Y-m-d H:i:s').'] '.json_encode($data, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);
}
function save_upload_general($field, $uploadsDir, $allowExt){
  if (!isset($_FILES[$field]) || !is_uploaded_file($_FILES[$field]['tmp_name'])) return null;
  $name = preg_replace('~[^a-zA-Z0-9_\.-]+~u','-', $_FILES[$field]['name']);
  $ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
  if (!in_array($ext, $allowExt)) throw new Exception('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç: '.esc($ext));
  if ($_FILES[$field]['size'] > 100*1024*1024) throw new Exception('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 100 –ú–ë).');
  $newName = date('Ymd-His').'-'.bin2hex(random_bytes(3)).'-'.$name;
  $dest = $uploadsDir.'/'.$newName;
  if (!move_uploaded_file($_FILES[$field]['tmp_name'], $dest)) throw new Exception('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª.');
  return $newName;
}
function save_upload_order($field, $uploadsDir){
  $allowed = ['jpg','jpeg','png','pdf','svg','tif','tiff','ai','psd','cdr','eps','zip','rar','doc','docx','xls','xlsx','ppt','pptx'];
  return save_upload_general($field, $uploadsDir, $allowed);
}
function save_upload_image($field, $uploadsDir){
  $allowed = ['jpg','jpeg','png','webp','svg'];
  return save_upload_general($field, $uploadsDir, $allowed);
}

/* Email helpers */
function parse_emails($s){
  $s = str_replace([';','\n','\r'],',',$s);
  $parts = array_filter(array_map('trim', explode(',', (string)$s)));
  $out = [];
  foreach($parts as $p){
    if (filter_var($p, FILTER_VALIDATE_EMAIL)) $out[] = $p;
  }
  return array_values(array_unique($out));
}

function email_headers($fromName, $from, $reply=null, $cc=null, $bcc=null){
  $h  = "MIME-Version: 1.0\r\n";
  $h .= "Content-Type: text/plain; charset=UTF-8\r\n";
  $h .= "From: $fromName <$from>\r\n";
  if ($reply) $h .= "Reply-To: $reply\r\n";
  if ($cc){
    $ccs = is_array($cc) ? implode(', ',$cc) : $cc;
    if($ccs) $h .= "Cc: $ccs\r\n";
  }
  if ($bcc){
    $bccs = is_array($bcc) ? implode(', ',$bcc) : $bcc;
    if($bccs) $h .= "Bcc: $bccs\r\n";
  }
  $h .= "X-Priority: 1\r\nX-Mailer: SmartPrint\r\n";
  return $h;
}

function email_send_mail($to,$subj,$body,$fromName,$from,$reply=null,$cc=null,$bcc=null){
  $h = email_headers($fromName,$from,$reply,$cc,$bcc);
  $toStr = is_array($to) ? implode(', ',$to) : $to;
  return @mail($toStr, '=?UTF-8?B?'.base64_encode($subj).'?=', $body, $h);
}

function smtp_cmd($fp,$cmd,$expect=null){
  if ($cmd !== null) fwrite($fp, $cmd."\r\n");
  $resp=''; while($line=fgets($fp, 515)){ $resp.=$line; if(isset($line[3])&&$line[3]===' ') break; }
  if ($expect && strpos($resp,(string)$expect)!==0) throw new Exception("SMTP error: expected $expect, got: ".$resp);
  return $resp;
}

function email_send_smtp($to,$subj,$body,$fromName,$from,$smtp,$reply=null,$cc=null,$bcc=null){
  $host=$smtp['host']; $port=(int)$smtp['port']; $secure=strtolower($smtp['secure']??'ssl');
  $ctx=stream_context_create(['ssl'=>['verify_peer'=>false,'verify_peer_name'=>false]]);
  $endpoint=(($secure==='ssl')?'ssl://':'tcp://').$host.':'.$port;
  $fp=@stream_socket_client($endpoint,$errno,$errstr,15,STREAM_CLIENT_CONNECT,$ctx);
  if(!$fp) throw new Exception("SMTP connect failed: $errstr");
  stream_set_timeout($fp,15);
  smtp_cmd($fp,null,220);
  smtp_cmd($fp,'EHLO localhost',250);
  if($secure==='tls'){ smtp_cmd($fp,'STARTTLS',220); if(!stream_socket_enable_crypto($fp,true,STREAM_CRYPTO_METHOD_TLS_CLIENT)) throw new Exception('STARTTLS failed'); smtp_cmd($fp,'EHLO localhost',250); }
  if (!empty($smtp['user'])){ smtp_cmd($fp,'AUTH LOGIN',334); smtp_cmd($fp,base64_encode($smtp['user']),334); smtp_cmd($fp,base64_encode($smtp['pass']),235); }
  smtp_cmd($fp,"MAIL FROM:<$from>",250);
  $rcpts = [];
  foreach ((array)$to as $rcpt) $rcpts[]=$rcpt;
  foreach ((array)$cc as $rcpt) $rcpts[]=$rcpt;
  foreach ((array)$bcc as $rcpt) $rcpts[]=$rcpt;
  $rcpts = array_values(array_unique(array_filter($rcpts)));
  foreach ($rcpts as $rcpt) smtp_cmd($fp,"RCPT TO:<$rcpt>",250);
  smtp_cmd($fp,'DATA',354);
  $data  = email_headers($fromName,$from,$reply,$cc,$bcc);
  $allToHeader = array_values(array_unique(array_merge((array)$to,(array)$cc)));
  $data .= 'To: <'.(implode(', ',$allToHeader)).">\r\n";
  $data .= 'Subject: =?UTF-8?B?'.base64_encode($subj)."?=\r\n\r\n".$body."\r\n.\r\n";
  fwrite($fp,$data);
  $r=fgets($fp,515); if (strpos($r,'250')!==0) throw new Exception('SMTP DATA not accepted: '.$r);
  smtp_cmd($fp,'QUIT',221); fclose($fp); return true;
}

function send_email_all($cfg,$subject,$body){
  $to = parse_emails($cfg['email_to']);
  if (empty($to)) $to = [$cfg['email_to']];
  $cc = parse_emails($cfg['email_cc'] ?? '');
  $bcc= parse_emails($cfg['email_bcc'] ?? '');
  $reply = trim($cfg['email_reply'] ?? '') ?: null;
  $from = $cfg['email_from'];
  $ok=false; $errs=[];
  if (!empty($cfg['smtp']['enabled'])){
    try{ email_send_smtp($to,$subject,$body,'SmartPrint',$from,$cfg['smtp'],$reply,$cc,$bcc); $ok=true; }
    catch(Throwable $e){ $errs[]='SMTP: '.$e->getMessage(); }
  }
  if(!$ok){ $ok=email_send_mail($to,$subject,$body,'SmartPrint',$from,$reply,$cc,$bcc); if(!$ok) $errs[]='mail(): fail'; }
  return [$ok,$errs];
}

/* Telegram API */
function tg_api($token,$method,$params=[],$multipart=false){
  $url="https://api.telegram.org/bot$token/$method";
  $ch=curl_init($url);
  curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
  curl_setopt($ch,CURLOPT_CONNECTTIMEOUT,10);
  curl_setopt($ch,CURLOPT_TIMEOUT,20);
  if($multipart){ curl_setopt($ch,CURLOPT_POSTFIELDS,$params); }
  else{ curl_setopt($ch,CURLOPT_POSTFIELDS,http_build_query($params)); }
  $resp=curl_exec($ch); $err=curl_error($ch); curl_close($ch);
  if($err) throw new Exception('Telegram CURL: '.$err);
  $j=json_decode($resp,true);
  if(!$j || empty($j['ok'])) throw new Exception('Telegram API: '.$resp);
  return $j['result'] ?? true;
}

function tg_send_message_cfg($cfg,$text){
  if(empty($cfg['telegram']['enabled'])) return [false,'disabled'];
  $token=$cfg['telegram']['token']??''; $chat=$cfg['telegram']['chat']??'';
  if(!$token || !$chat) return [false,'no token/chat'];
  try{ tg_api($token,'sendMessage',['chat_id'=>$chat,'text'=>$text,'parse_mode'=>'HTML','disable_web_page_preview'=>true]); return [true,null]; }
  catch(Throwable $e){ return [false,$e->getMessage()]; }
}

function tg_send_file_cfg($cfg,$file,$caption=''){
  if(empty($cfg['telegram']['enabled'])) return [false,'disabled'];
  $token=$cfg['telegram']['token']??''; $chat=$cfg['telegram']['chat']??'';
  if(!$token || !$chat) return [false,'no token/chat'];
  if(!is_file($file)) return [false,'file not found'];
  try{
    tg_api($token,'sendDocument',[
      'chat_id'=>$chat,
      'caption'=>$caption,
      'document'=>new CURLFile($file, mime_content_type($file)?:'application/octet-stream', basename($file))
    ], true);
    return [true,null];
  }catch(Throwable $e){ return [false,$e->getMessage()]; }
}

/* –Æ–ö–∞—Å—Å–∞ Integration */
function yukassa_create_payment($cfg, $amount, $description, $order_id, $return_url = null){
  if(empty($cfg['yukassa']['enabled'])) return [false, 'Payments disabled'];

  $shop_id = $cfg['yukassa']['shop_id'];
  $secret_key = $cfg['yukassa']['secret_key'];
  if (!$return_url) $return_url = $cfg['yukassa']['return_url'];

  if(!$shop_id || !$secret_key) return [false, 'Missing shop_id or secret_key'];

  $url = 'https://api.yookassa.ru/v3/payments';

  $data = [
    'amount' => ['value' => number_format($amount, 2, '.', ''), 'currency' => 'RUB'],
    'confirmation' => ['type' => 'redirect', 'return_url' => $return_url],
    'description' => $description,
    'metadata' => ['order_id' => (string)$order_id],
    'capture' => true
  ];

  $ch = curl_init($url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($ch, CURLOPT_POST, true);
  curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
  curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
    'Idempotence-Key: ' . uniqid(),
    'Authorization: Basic ' . base64_encode($shop_id . ':' . $secret_key)
  ]);

  $result = curl_exec($ch);
  $error = curl_error($ch);
  curl_close($ch);

  if($error) return [false, 'CURL error: ' . $error];

  $response = json_decode($result, true);
  if(!$response || !isset($response['confirmation']['confirmation_url'])) {
    return [false, 'Invalid response: ' . $result];
  }

  return [true, $response];
}

function yukassa_check_payment($cfg, $payment_id){
  if(empty($cfg['yukassa']['enabled'])) return [false, 'Payments disabled'];

  $shop_id = $cfg['yukassa']['shop_id'];
  $secret_key = $cfg['yukassa']['secret_key'];

  if(!$shop_id || !$secret_key) return [false, 'Missing credentials'];

  $url = "https://api.yookassa.ru/v3/payments/$payment_id";

  $ch = curl_init($url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Authorization: Basic ' . base64_encode($shop_id . ':' . $secret_key)
  ]);

  $result = curl_exec($ch);
  $error = curl_error($ch);
  curl_close($ch);

  if($error) return [false, 'CURL error: ' . $error];

  $response = json_decode($result, true);
  if(!$response) return [false, 'Invalid response: ' . $result];

  return [true, $response];
}

/* Sitemap generation */
function generate_sitemap($cfg) {
  $sitemap = '<?xml version="1.0" encoding="UTF-8"?' . '>' . "\n";
  $sitemap .= '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' . "\n";

  $sitemap .= '<url><loc>' . esc($cfg['site']) . '</loc><changefreq>weekly</changefreq><priority>1.0</priority></url>' . "\n";

  $sections = ['catalog', 'calc', 'services', 'how', 'contacts'];
  foreach($sections as $section) {
    $sitemap .= '<url><loc>' . esc($cfg['site']) . '/#' . $section . '</loc><changefreq>monthly</changefreq><priority>0.8</priority></url>' . "\n";
  }

  $sitemap .= '</urlset>';
  return $sitemap;
}

/* API routes */
function require_admin($cfg){
  if(empty($_SESSION['is_admin'])){ header('Location: ?admin=1&login=1'); exit; }
}

// Sitemap route
if (isset($_GET['sitemap'])) {
  header('Content-Type: application/xml; charset=utf-8');
  echo generate_sitemap($cfg);
  exit;
}

// –û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫
if (($_POST['mode']??'')==='callback') {
  header('Content-Type: application/json; charset=utf-8');
  try{
    $name = sanitize_text($_POST['name']??'');
    $phone = sanitize_text($_POST['phone']??'');
    $time = sanitize_text($_POST['time']??'');

    if($name==='' || $phone==='') throw new Exception('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.');

    $callback = [
      'ts'=>date('Y-m-d H:i:s'),
      'name'=>$name,
      'phone'=>$phone,
      'preferred_time'=>$time,
      'ip'=>$_SERVER['REMOTE_ADDR']??'',
      'type'=>'callback'
    ];
    log_order($ordersLog, $callback);

    $body = "–ó–∞—è–≤–∫–∞ –Ω–∞ –æ–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ —Å —Å–∞–π—Ç–∞ {$cfg['brand']}\n\n"
          . "–ò–º—è: $name\n–¢–µ–ª–µ—Ñ–æ–Ω: $phone\n"
          . ($time ? "–£–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è: $time\n" : '')
          . "IP: {$callback['ip']}\n";

    [$mailOk,$mailErrs] = send_email_all($cfg, '–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ ‚Äî ' . $name, $body);

    $tgMsg = 'üìû <b>–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫</b>\nüë§ '.esc($name).'\nüì± '.esc($phone).'\n'
           . ($time ? 'üïê '.esc($time).'\n' : '')
           . "üåê $siteURL";
    [$tgOk,$tgErr] = tg_send_message_cfg($cfg, $tgMsg);

    echo json_encode([
      'ok'=>true,
      'message'=>'–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –ü–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç!',
      'emailOk'=>$mailOk,
      'tgOk'=>$tgOk
    ]);
    exit;
  }catch(Exception $e){
    echo json_encode(['ok'=>false,'message'=>$e->getMessage()]);
    exit;
  }
}

if ($_SERVER['REQUEST_METHOD']==='POST'){
  /* Order */
  if (($_POST['mode']??'')==='order'){
    header('Content-Type: application/json; charset=utf-8');
    try{
      $name = sanitize_text($_POST['name']??'');
      $phone= sanitize_text($_POST['phone']??'');
      $service=sanitize_text($_POST['service']??'');
      $price= sanitize_text($_POST['price']??'');
      $comment=sanitize_text($_POST['comment']??'');
      $calc = sanitize_text($_POST['calc']??'');
      $payment_method = sanitize_text($_POST['payment_method']??'');

      if($name===''||$phone===''||$service==='') throw new Exception('–£–∫–∞–∂–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —É—Å–ª—É–≥—É.');
      $saved=null; if(!empty($_FILES['file']['name'])) $saved=save_upload_order('file',$uploadsDir);

      $order_id = 'order_'.time().'_'.rand(1000,9999);

      $order = [
        'id'=>$order_id,
        'ts'=>date('Y-m-d H:i:s'),'name'=>$name,'phone'=>$phone,'service'=>$service,'price'=>$price,'comment'=>$comment,'calc'=>$calc,
        'file'=>$saved?('uploads/'.$saved):null,'ip'=>$_SERVER['REMOTE_ADDR']??'','ua'=>$_SERVER['HTTP_USER_AGENT']??'',
        'payment_method'=>$payment_method,'type'=>'service','status'=>'new'
      ];
      log_order($ordersLog,$order);

      $body = "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞ {$cfg['brand']}\n\n"
            . "ID –∑–∞–∫–∞–∑–∞: $order_id\n"
            . "–ò–º—è: $name\n–¢–µ–ª–µ—Ñ–æ–Ω: $phone\n–£—Å–ª—É–≥–∞: $service\n"
            . ($price?"–û—Ä–∏–µ–Ω—Ç. —Ü–µ–Ω–∞: $price\n":'')
            . ($calc?"–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä: $calc\n":'')
            . ($comment?"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: $comment\n":'')
            . ($payment_method?"–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: $payment_method\n":'')
            . ($saved?"–§–∞–π–ª: $siteURL/uploads/$saved\n":'')
            . "IP: {$order['ip']}\n";
      [$mailOk,$mailErrs]=send_email_all($cfg,'–ó–∞—è–≤–∫–∞ ‚Äî '.$service,$body);

      $tgMsg = 'üÜï <b>'.esc($service).'</b>\nüë§ '.esc($name).'\nüìû '.esc($phone).'\n'
             . ($price?'üí∞ '.esc($price).'\n':'')
             . ($calc?'üìê '.esc($calc).'\n':'')
             . ($comment?'üí¨ '.esc($comment).'\n':'')
             . ($payment_method?'üí≥ –û–ø–ª–∞—Ç–∞: '.esc($payment_method).'\n':'')
             . ($saved?"üìé –§–∞–π–ª: $siteURL/uploads/$saved\n":'')
             . "üÜî $order_id\n"
             . "üåê $siteURL";
      [$tgOk,$tgErr]=tg_send_message_cfg($cfg,$tgMsg);
      if($saved) @tg_send_file_cfg($cfg, $BASE.'/uploads/'.basename($saved), '–ú–∞–∫–µ—Ç –∫ –∑–∞—è–≤–∫–µ');

      $response = ['ok'=>true,'emailOk'=>$mailOk,'tgOk'=>$tgOk,'order_id'=>$order_id];

      if($payment_method === 'online' && $price && preg_match('/(\d+)/', $price, $matches)) {
        $amount = (float)$matches[1];
        if($amount > 0) {
          [$payOk, $payResult] = yukassa_create_payment($cfg, $amount, $service, $order_id);
          if($payOk) {
            $response['payment'] = true;
            $response['payment_url'] = $payResult['confirmation']['confirmation_url'];
            $response['payment_id'] = $payResult['id'];
            $response['message'] = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ...';
          } else {
            $response['message'] = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' . $payResult;
          }
        }
      } else {
        $response['message'] = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.';
        if(!$mailOk) $response['message'] .= ' (email –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏ –≤ Telegram/–∂—É—Ä–Ω–∞–ª)';
      }

      echo json_encode($response); exit;
    }catch(Exception $e){
      echo json_encode(['ok'=>false,'message'=>$e->getMessage()]); exit;
    }
  }

  // –ó–∞–∫–∞–∑ –∫–æ—Ä–∑–∏–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤
  if (($_POST['mode']??'')==='cart_order'){
    header('Content-Type: application/json; charset=utf-8');
    try{
      $name = sanitize_text($_POST['name']??'');
      $phone= sanitize_text($_POST['phone']??'');
      $comment=sanitize_text($_POST['comment']??'');
      $cart = json_decode($_POST['cart']??'[]', true);
      $payment_method = sanitize_text($_POST['payment_method']??'offline');

      if($name===''||$phone==='') throw new Exception('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.');
      if(empty($cart)) throw new Exception('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.');

      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ
      $products = json_decode(@file_get_contents($BASE.'/products.json'), true) ?? [];
      $totalPrice = 0;
      $orderItems = [];

      foreach($cart as $item){
        $product = null;
        foreach($products as $p){
          if($p['id'] == $item['id'] && $p['enabled']){
            $product = $p;
            break;
          }
        }
        if(!$product) continue;
        if($product['stock'] < $item['quantity']) throw new Exception('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ: '.$product['name']);

        $itemTotal = $product['price'] * $item['quantity'];
        $totalPrice += $itemTotal;
        $orderItems[] = [
          'product_id'=>$product['id'],
          'name'=>$product['name'],
          'price'=>$product['price'],
          'quantity'=>$item['quantity'],
          'total'=>$itemTotal
        ];
      }

      $order_id = 'cart_'.time().'_'.rand(1000,9999);

      $order = [
        'id'=>$order_id,
        'type'=>'cart',
        'ts'=>date('Y-m-d H:i:s'),
        'items'=>$orderItems,
        'total_price'=>$totalPrice,
        'name'=>$name,
        'phone'=>$phone,
        'comment'=>$comment,
        'payment_method'=>$payment_method,
        'ip'=>$_SERVER['REMOTE_ADDR']??'',
        'status'=>'new'
      ];

      log_order($ordersLog, $order);

      // –û—Ç–ø—Ä–∞–≤–∫–∞ email
      $emailBody = "–ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Å–∞–π—Ç–∞ {$cfg['brand']}\n\nID –∑–∞–∫–∞–∑–∞: $order_id\n\n";
      foreach($orderItems as $item){
        $emailBody .= "‚Ä¢ {$item['name']} - {$item['price']} ‚ÇΩ √ó {$item['quantity']} —à—Ç = {$item['total']} ‚ÇΩ\n";
      }
      $emailBody .= "\n–ò—Ç–æ–≥–æ: $totalPrice ‚ÇΩ\n\n";
      $emailBody .= "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: $name\n";
      $emailBody .= "–¢–µ–ª–µ—Ñ–æ–Ω: $phone\n";
      if($comment) $emailBody .= "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: $comment\n";
      $emailBody .= "–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: ".($payment_method==='online'?'–û–Ω–ª–∞–π–Ω':'–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏')."\n";
      $emailBody .= "IP: {$order['ip']}\n\n";
      $emailBody .= "–û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∑–∞–∫–∞–∑ –≤ –∞–¥–º–∏–Ω–∫–µ!";

      [$mailOk,$mailErrs]=send_email_all($cfg,'–ó–∞–∫–∞–∑ –∫–æ—Ä–∑–∏–Ω—ã #'.$order_id,$emailBody);

      // Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      $tgMsg = 'üõí <b>–ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤ #'.esc($order_id).'</b>\n\n';
      foreach($orderItems as $item){
        $tgMsg .= '‚Ä¢ '.esc($item['name']).' √ó '.$item['quantity'].' = '.number_format($item['total']).' ‚ÇΩ\n';
      }
      $tgMsg .= '\nüí∞ <b>–ò—Ç–æ–≥–æ: '.number_format($totalPrice).' ‚ÇΩ</b>\n\n';
      $tgMsg .= 'üë§ '.esc($name).'\nüìû '.esc($phone).'\n';
      if($comment) $tgMsg .= 'üí¨ '.esc($comment).'\n';
      $tgMsg .= 'üí≥ '.($payment_method==='online'?'–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞':'–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏').'\n';
      $tgMsg .= "üåê $siteURL";

      [$tgOk,$tgErr]=tg_send_message_cfg($cfg,$tgMsg);

      $response = ['ok'=>true,'emailOk'=>$mailOk,'tgOk'=>$tgOk,'order_id'=>$order_id];

      if($payment_method === 'online' && $totalPrice > 0) {
        [$payOk, $payResult] = yukassa_create_payment($cfg, $totalPrice, "–ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤ #$order_id", $order_id);
        if($payOk) {
          $response['payment'] = true;
          $response['payment_url'] = $payResult['confirmation']['confirmation_url'];
          $response['payment_id'] = $payResult['id'];
          $response['message'] = '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ...';
        } else {
          $response['message'] = '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç. –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' . $payResult;
        }
      } else {
        $response['message'] = '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.';
      }

      echo json_encode($response);
      exit;

    }catch(Exception $e){
      echo json_encode(['ok'=>false,'message'=>$e->getMessage()]);
      exit;
    }
  }

  if (isset($_POST['admin_login'])){
    $pass=$_POST['password']??''; if(hash_equals($cfg['admin_pass'],$pass)){ $_SESSION['is_admin']=true; header('Location: ?admin=1'); }
    else { header('Location: ?admin=1&login=1&err=1'); }
    exit;
  }

  if (isset($_POST['admin_save'])){
    require_admin($cfg);
    $new=$cfg;
    foreach(['brand','slogan','hero','phone_display','phone_raw','email_to','email_from','email_cc','email_bcc','email_reply','address','hero_mode','hero_image','catalog_desc'] as $f){
      if(isset($_POST[$f])) $new[$f]=trim($_POST[$f]);
    }
    if(isset($_POST['workhours'])){
      $wh=array_filter(array_map('trim', explode("\n", str_replace("\r",'',$_POST['workhours']))));
      if($wh) $new['workhours']=array_values($wh);
    }
    if(!empty($_POST['admin_pass'])) $new['admin_pass']=$_POST['admin_pass'];

    if(isset($_POST['seo']) && is_array($_POST['seo'])){
      $new['seo']['title'] = trim($_POST['seo']['title'] ?? $new['seo']['title']);
      $new['seo']['description'] = trim($_POST['seo']['description'] ?? $new['seo']['description']);
      $new['seo']['keywords'] = trim($_POST['seo']['keywords'] ?? $new['seo']['keywords']);
      $new['seo']['og_image'] = trim($_POST['seo']['og_image'] ?? $new['seo']['og_image']);
      $new['seo']['sitemap_enable'] = !empty($_POST['seo']['sitemap_enable']);
    }

    if(isset($_POST['business']) && is_array($_POST['business'])){
      $new['business']['show_requisites'] = !empty($_POST['business']['show_requisites']);
      $new['business']['show_payment_icons'] = !empty($_POST['business']['show_payment_icons']);
      $new['business']['legal_name'] = trim($_POST['business']['legal_name'] ?? $new['business']['legal_name']);
      $new['business']['inn'] = trim($_POST['business']['inn'] ?? $new['business']['inn']);
      $new['business']['ogrn'] = trim($_POST['business']['ogrn'] ?? $new['business']['ogrn']);
      $new['business']['bank'] = trim($_POST['business']['bank'] ?? $new['business']['bank']);
      $new['business']['bik'] = trim($_POST['business']['bik'] ?? $new['business']['bik']);
      $new['business']['account'] = trim($_POST['business']['account'] ?? $new['business']['account']);
    }

    if(isset($_POST['social']) && is_array($_POST['social'])){
      foreach(['vk','instagram','youtube','whatsapp','telegram_channel'] as $s) {
        $new['social'][$s] = trim($_POST['social'][$s] ?? $new['social'][$s]);
      }
    }

    if(isset($_POST['yukassa']) && is_array($_POST['yukassa'])){
      $new['yukassa']['enabled'] = !empty($_POST['yukassa']['enabled']);
      $new['yukassa']['shop_id'] = trim($_POST['yukassa']['shop_id'] ?? $new['yukassa']['shop_id']);
      $new['yukassa']['test_mode'] = !empty($_POST['yukassa']['test_mode']);
      $new['yukassa']['return_url'] = trim($_POST['yukassa']['return_url'] ?? $new['yukassa']['return_url']);
      if(isset($_POST['yukassa']['secret_key']) && $_POST['yukassa']['secret_key'] !== '__KEEP__') {
        $new['yukassa']['secret_key'] = $_POST['yukassa']['secret_key'];
      }
    }

    $new['smtp']['enabled']=!empty($_POST['smtp_enabled']);
    $new['smtp']['host']=trim($_POST['smtp_host']??$new['smtp']['host']);
    $new['smtp']['port']=(int)($_POST['smtp_port']??$new['smtp']['port']);
    $new['smtp']['secure']=in_array($_POST['smtp_secure']??'ssl',['ssl','tls','none'])?$_POST['smtp_secure']:'ssl';
    $new['smtp']['user']=trim($_POST['smtp_user']??$new['smtp']['user']);
    if(isset($_POST['smtp_pass']) && $_POST['smtp_pass']!=='__KEEP__') $new['smtp']['pass']=$_POST['smtp_pass'];

    $new['telegram']['enabled']=!empty($_POST['tg_enabled']);
    $new['telegram']['token']=trim($_POST['tg_token']??$new['telegram']['token']);
    $new['telegram']['chat']=trim($_POST['tg_chat']??$new['telegram']['chat']);

    if(isset($_POST['theme']) && is_array($_POST['theme'])){
      $t=$new['theme'];
      $t['mode']  = in_array(($_POST['theme']['mode']??'light'),['light','dark'])?$_POST['theme']['mode']:'light';
      $t['bg']    = sanitize_hex($_POST['theme']['bg']   ?? $t['bg']);
      $t['text']  = sanitize_hex($_POST['theme']['text'] ?? $t['text']);
      $t['muted'] = sanitize_hex($_POST['theme']['muted']?? $t['muted']);
      $t['brand'] = sanitize_hex($_POST['theme']['brand']?? $t['brand']);
      $t['accent']= sanitize_hex($_POST['theme']['accent']??$t['accent']);
      $t['card_opacity']= clamp_float($_POST['theme']['card_opacity']??$t['card_opacity'], 0.3, 1.0, 0.65);
      $t['blur']  = clamp_int($_POST['theme']['blur']??$t['blur'], 0, 30, 12);
      $t['radius']= clamp_int($_POST['theme']['radius']??$t['radius'], 0, 28, 16);
      $t['shadow']= clamp_float($_POST['theme']['shadow']??$t['shadow'], 0, 0.5, 0.12);
      $t['container']= clamp_int($_POST['theme']['container']??$t['container'], 900, 1400, 1200);
      $new['theme']=$t;
    }

    @file_put_contents($configFile, json_encode($new, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    header('Location: ?admin=1&saved=1'); exit;
  }

  if (isset($_POST['admin_upload'])){
    require_admin($cfg);
    try{
      $what=$_POST['what']??'';
      if($what==='logo'){
        $fn=save_upload_image('file',$uploadsDir);
        $cfg['logo']='/uploads/'.$fn;
      } elseif($what==='hero'){
        $fn=save_upload_image('file',$uploadsDir);
        $cfg['hero_mode']='image';
        $cfg['hero_image']='/uploads/'.$fn;
      } else { throw new Exception('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∑–∞–≥—Ä—É–∑–∫–∏'); }
      @file_put_contents($configFile, json_encode($cfg, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
      header('Location: ?admin=1&saved=1'); exit;
    }catch(Exception $e){
      header('Location: ?admin=1&err='.urlencode($e->getMessage())); exit;
    }
  }

  if (isset($_POST['admin_test_email'])){ require_admin($cfg); [$ok,$errs]=send_email_all($cfg,'–¢–µ—Å—Ç SmartPrint', '–¢–µ—Å—Ç —Å '.$cfg['site'].' '.date('Y-m-d H:i:s')); header('Location: ?admin=1&test_email='.($ok?'ok':'fail')); exit; }
  if (isset($_POST['admin_test_tg'])){ require_admin($cfg); [$ok,$err]=tg_send_message_cfg($cfg,'–¢–µ—Å—Ç Telegram '.date('Y-m-d H:i:s')); header('Location: ?admin=1&test_tg='.($ok?'ok':'fail')); exit; }

  if (isset($_POST['tg_delete_webhook'])){ require_admin($cfg);
    try{ tg_api($cfg['telegram']['token'],'deleteWebhook'); header('Location: ?admin=1&tg_webhook=deleted'); }
    catch(Throwable $e){ header('Location: ?admin=1&tg_webhook=err'); } exit;
  }
  if (isset($_POST['tg_get_updates'])){ require_admin($cfg);
    $_SESSION['tg_updates'] = null;
    try{ $res = tg_api($cfg['telegram']['token'],'getUpdates', ['timeout'=>0]); $_SESSION['tg_updates']=$res; header('Location: ?admin=1&tg_updates=ok'); }
    catch(Throwable $e){ header('Location: ?admin=1&tg_updates=err'); }
    exit;
  }
  if (isset($_POST['tg_use_chat'])){ require_admin($cfg);
    $chat = trim($_POST['chat']??'');
    if ($chat!==''){ $cfg['telegram']['chat']=$chat; @file_put_contents($configFile, json_encode($cfg, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT)); header('Location: ?admin=1&tg_chat=saved'); }
    else { header('Location: ?admin=1&tg_chat=err'); }
    exit;
  }
}

/* Admin UI —Å —É–º–Ω—ã–º–∏ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞–º–∏ */
if (isset($_GET['admin'])):
  $isLogin = isset($_GET['login']) || empty($_SESSION['is_admin']);
  ?><!doctype html><html lang='ru'><head>
  <meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>–ê–¥–º–∏–Ω ‚Äî <?=esc($cfg['brand'])?></title>
  <style>
    :root{--bg:#0f1115;--panel:#151a22;--muted:#a7b0c0;--brand:#FFD400;--accent:#2D5BFF;--ok:#66e38a;--bad:#ff7a7a;--text:#e9eef7}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,Roboto}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.row{grid-template-columns:1fr}}
    input,textarea,select{width:100%;background:#121825;border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:12px;padding:10px;box-sizing:border-box}
    .btn{background:linear-gradient(90deg,var(--accent),#00c2ff);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn2{background:#1b2232;border:1px solid rgba(255,255,255,.15);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .ok{color:var(--ok)} .bad{color:var(--bad)}

    /* –£–ú–ù–´–ï –ó–ê–ì–†–£–ó–ß–ò–ö–ò */
    .drop{position:relative;display:grid;place-items:center;min-height:130px;border:1.5px dashed rgba(255,255,255,.25);border-radius:14px;background:#0f1624;cursor:pointer;transition:all 0.3s}
    .drop.hover{background:#0c1220;border-color:var(--brand)}
    .drop input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .drop-content{text-align:center;pointer-events:none}
    .drop-icon{font-size:32px;margin-bottom:8px;opacity:0.7}
    .drop-text{font-size:14px;font-weight:600;margin-bottom:4px}
    .drop-hint{font-size:12px;opacity:0.6}
    .drop.has-image{border-style:solid;border-color:var(--brand)}
    .drop-preview{max-width:100%;max-height:100px;border-radius:8px;margin-bottom:8px}
    .drop-remove{position:absolute;top:8px;right:8px;background:rgba(255,0,0,.8);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px;display:none}
    .drop.has-image .drop-remove{display:block}

    .mini{font-size:12px}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
  <meta name='robots' content='noindex,nofollow'>
  </head><body><div class='wrap'>
  <h1>–ê–¥–º–∏–Ω ‚Äî <?=esc($cfg['brand'])?></h1>
  <?php if ($isLogin): ?>
    <div class='card'>
      <h3>–í—Ö–æ–¥</h3>
      <?php if(isset($_GET['err'])): ?><div class='bad'>–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div><?php endif; ?>
      <form method='post'><input type='password' name='password' placeholder='–ü–∞—Ä–æ–ª—å (config.json -> admin_pass)' required>
        <div style='margin-top:10px'><button class='btn' name='admin_login' value='1'>–í–æ–π—Ç–∏</button></div>
      </form>
      <div class='muted mini' style='margin-top:8px'>–ü–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: <?=esc($cfg['admin_pass'])?> ‚Äî —Å–º–µ–Ω–∏—Ç–µ.</div>
    </div>
  <?php else: ?>
    <div class='row'>
      <div class='card'>
        <h3>–ó–∞—è–≤–∫–∏ –∏ —á–∞—Ç-–ª–æ–≥–∏</h3>
        <div class='muted mini'>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 200 –∑–∞–ø–∏—Å–µ–π</div>
        <div style='max-height:420px;overflow:auto;margin-top:8px'>
          <table><tr><th>–í—Ä–µ–º—è</th><th>–¢–∏–ø</th><th>–ò–º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–£—Å–ª—É–≥–∞/–¢–æ–≤–∞—Ä—ã</th><th>–¶–µ–Ω–∞</th><th>–û–ø–ª–∞—Ç–∞</th><th>–§–∞–π–ª</th></tr>
          <?php
            $lines=@file($ordersLog, FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES)?:[];
            $lines=array_slice(array_reverse($lines),0,200);
            foreach($lines as $line){
              if(!preg_match('~^$$(.+?)$$\s*(.+)$~u',$line,$m)) continue;
              $ts=$m[1]; $j=json_decode($m[2],true);
              if(!$j) continue;
              echo '<tr>';
              echo '<td><small>'.esc(date('d.m H:i',strtotime($ts))).'</small></td>';
              $type = $j['type'] ?? 'service';
              $typeIcon = $type==='cart'?'üõí':($type==='callback'?'üìû':'üìã');
              echo '<td>'.$typeIcon.'</td>';
              echo '<td>'.esc($j['name']??'').'</td>';
              echo '<td>'.esc($j['phone']??'').'</td>';

              if($type==='cart'){
                $itemCount = count($j['items']??[]);
                echo '<td>'.$itemCount.' —Ç–æ–≤–∞—Ä–æ–≤</td>';
                echo '<td><strong>'.number_format($j['total_price']??0).' ‚ÇΩ</strong></td>';
              } elseif($type==='callback'){
                echo '<td>–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫</td>';
                echo '<td>‚Äî</td>';
              } else {
                echo '<td>'.esc($j['service']??'').'</td>';
                echo '<td>'.esc($j['price']??'‚Äî').'</td>';
              }

              echo '<td>'.esc($j['payment_method']??'‚Äî').'</td>';
              if(!empty($j['file'])){ $f=basename($j['file']); echo '<td><a href="uploads/'.esc($f).'" target="_blank">—Å–∫–∞—á–∞—Ç—å</a></td>'; }
              else echo '<td class="muted">‚Äî</td>';
              echo '</tr>';
            }
          ?>
          </table>
        </div>
        <form method='post' class='flex' style='margin-top:10px'>
          <button class='btn' name='admin_test_email' value='1'>–¢–µ—Å—Ç Email</button>
          <?php if(isset($_GET['test_email'])): ?><span class='<?=($_GET['test_email']==='ok'?'ok':'bad')?>'><?=($_GET['test_email']==='ok'?'OK':'–û—à–∏–±–∫–∞')?></span><?php endif; ?>
          <button class='btn2' name='admin_test_tg' value='1'>–¢–µ—Å—Ç Telegram</button>
          <?php if(isset($_GET['test_tg'])): ?><span class='<?=($_GET['test_tg']==='ok'?'ok':'bad')?>'><?=($_GET['test_tg']==='ok'?'OK':'–û—à–∏–±–∫–∞')?></span><?php endif; ?>
        </form>
      </div>

      <div class='card'>
        <h3>üé® –õ–æ–≥–æ—Ç–∏–ø –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
        <?php if(isset($_GET['saved'])): ?><div class='ok'>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div><?php endif; ?>
        <?php if(isset($_GET['err'])): ?><div class='bad'><?=esc($_GET['err'])?></div><?php endif; ?>

        <div class='row' style='margin-top:12px'>
          <div>
            <h4>–õ–æ–≥–æ—Ç–∏–ø</h4>
            <form method='post' enctype='multipart/form-data' id='logoForm'>
              <input type='hidden' name='admin_upload' value='1'>
              <input type='hidden' name='what' value='logo'>
              <div class='drop <?=!empty($cfg['logo'])?'has-image':''?>' id='logoDrop'>
                <input type='file' name='file' accept='image/*' onchange='handleFileUpload(this, "logoDrop", "logoForm")'>
                <button type='button' class='drop-remove' onclick='removeImage("logoDrop", "logo")'>‚úï</button>
                <div class='drop-content'>
                  <?php if(!empty($cfg['logo'])): ?>
                    <img src='<?=esc($cfg['logo'])?>' class='drop-preview' alt='–õ–æ–≥–æ—Ç–∏–ø'>
                    <div class='drop-text'>–õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    <div class='drop-hint'>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>
                  <?php else: ?>
                    <div class='drop-icon'>üñºÔ∏è</div>
                    <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</div>
                    <div class='drop-hint'>PNG, JPG, SVG –¥–æ 10 –ú–ë</div>
                  <?php endif; ?>
                </div>
              </div>
            </form>
          </div>

          <div>
            <h4>Hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
            <form method='post' enctype='multipart/form-data' id='heroForm'>
              <input type='hidden' name='admin_upload' value='1'>
              <input type='hidden' name='what' value='hero'>
              <div class='drop <?=($cfg['hero_mode']==='image'&&!empty($cfg['hero_image']))?'has-image':''?>' id='heroDrop'>
                <input type='file' name='file' accept='image/*' onchange='handleFileUpload(this, "heroDrop", "heroForm")'>
                <button type='button' class='drop-remove' onclick='removeImage("heroDrop", "hero")'>‚úï</button>
                <div class='drop-content'>
                  <?php if($cfg['hero_mode']==='image'&&!empty($cfg['hero_image'])): ?>
                    <img src='<?=esc($cfg['hero_image'])?>' class='drop-preview' alt='Hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'>
                    <div class='drop-text'>Hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
                    <div class='drop-hint'>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>
                  <?php else: ?>
                    <div class='drop-icon'>üé®</div>
                    <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                    <div class='drop-hint'>PNG, JPG –¥–æ 10 –ú–ë</div>
                  <?php endif; ?>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class='card'>
      <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <form method='post'>
        <div class='row'>
          <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ<br><input name='brand' value='<?=esc($cfg['brand'])?>'></label></div>
          <div><label>–°–ª–æ–≥–∞–Ω<br><input name='slogan' value='<?=esc($cfg['slogan'])?>'></label></div>
        </div>
        <div class='row'>
          <div><label>–¢–µ–ª–µ—Ñ–æ–Ω (–≤–∏–¥–∏–º—ã–π)<br><input name='phone_display' value='<?=esc($cfg['phone_display'])?>'></label></div>
          <div><label>–¢–µ–ª–µ—Ñ–æ–Ω (raw)<br><input name='phone_raw' value='<?=esc($cfg['phone_raw'])?>'></label></div>
        </div>

        <div class='card' style='margin:12px 0;border:2px solid var(--brand)'>
          <h4>üí≥ –Æ–ö–∞—Å—Å–∞ (–æ–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–∏)</h4>
          <div style='margin-top:8px'><label><input type='checkbox' name='yukassa[enabled]' <?=!empty($cfg['yukassa']['enabled'])?'checked':''?>> –í–∫–ª—é—á–∏—Ç—å –æ–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–∏</label></div>
          <div class='row' style='margin-top:8px'>
            <div><label>Shop ID<br><input name='yukassa[shop_id]' value='<?=esc($cfg['yukassa']['shop_id'])?>' placeholder='123456'></label></div>
            <div><label>Secret Key<br><input name='yukassa[secret_key]' type='password' value='<?=!empty($cfg['yukassa']['secret_key'])?'__KEEP__':''?>' placeholder='live_...'></label></div>
          </div>
          <div class='row' style='margin-top:8px'>
            <div><label>Return URL<br><input name='yukassa[return_url]' value='<?=esc($cfg['yukassa']['return_url'])?>'></label></div>
            <div><label><input type='checkbox' name='yukassa[test_mode]' <?=!empty($cfg['yukassa']['test_mode'])?'checked':''?>> –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º</label></div>
          </div>
          <div class='mini muted' style='margin-top:4px'>–ü–æ–ª—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å–∞. –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —Ä–µ–∞–ª—å–Ω–æ.</div>
        </div>

        <div><label>Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è<br><input name='email_to' value='<?=esc($cfg['email_to'])?>'></label></div>
        <div><label>–ê–¥—Ä–µ—Å<br><input name='address' value='<?=esc($cfg['address'])?>'></label></div>

        <div class='card' style='margin:12px 0'>
          <h4>üé® –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h4>
          <div class='row'>
            <div><label>–¶–≤–µ—Ç –±—Ä–µ–Ω–¥–∞<br><input name='theme[brand]' type='color' value='<?=esc($cfg['theme']['brand'])?>'></label></div>
            <div><label>–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç<br><input name='theme[accent]' type='color' value='<?=esc($cfg['theme']['accent'])?>'></label></div>
          </div>
          <div class='row' style='margin-top:8px'>
            <div><label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫–∞—Ä—Ç<br><input name='theme[card_opacity]' type='range' min='0.3' max='1' step='0.05' value='<?=esc($cfg['theme']['card_opacity'])?>'></label></div>
            <div><label>–†–∞–∑–º—ã—Ç–∏–µ<br><input name='theme[blur]' type='range' min='0' max='30' value='<?=esc($cfg['theme']['blur'])?>'></label></div>
          </div>
        </div>

        <div style='margin-top:10px'><button class='btn' name='admin_save' value='1'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      </form>
    </div>

    <div class='row'>
      <div class='card'>
        <h3>üìß Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <form method='post'>
          <div><label><input type='checkbox' name='smtp_enabled' <?=!empty($cfg['smtp']['enabled'])?'checked':''?>> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SMTP</label></div>
          <div class='row' style='margin-top:8px'>
            <div><label>SMTP —Ö–æ—Å—Ç<br><input name='smtp_host' value='<?=esc($cfg['smtp']['host'])?>' placeholder='smtp.mail.ru'></label></div>
            <div><label>–ü–æ—Ä—Ç<br><input name='smtp_port' type='number' value='<?=esc($cfg['smtp']['port'])?>' placeholder='465'></label></div>
          </div>
          <div class='row' style='margin-top:8px'>
            <div><label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å<br><input name='smtp_user' value='<?=esc($cfg['smtp']['user'])?>' placeholder='user@mail.ru'></label></div>
            <div><label>–ü–∞—Ä–æ–ª—å<br><input name='smtp_pass' type='password' value='<?=!empty($cfg['smtp']['pass'])?'__KEEP__':''?>' placeholder='password'></label></div>
          </div>
          <div style='margin-top:10px'><button class='btn' name='admin_save' value='1'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Email</button></div>
        </form>
      </div>

      <div class='card'>
        <h3>üì± Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <form method='post'>
          <div><label><input type='checkbox' name='tg_enabled' <?=!empty($cfg['telegram']['enabled'])?'checked':''?>> –í–∫–ª—é—á–∏—Ç—å Telegram</label></div>
          <div><label>Bot Token<br><input name='tg_token' value='<?=esc($cfg['telegram']['token'])?>' placeholder='123456789:ABC...'></label></div>
          <div><label>Chat ID<br><input name='tg_chat' value='<?=esc($cfg['telegram']['chat'])?>' placeholder='-100123456789'></label></div>

          <div class='flex' style='margin-top:10px'>
            <button class='btn' name='admin_save' value='1'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å TG</button>
            <button class='btn2' name='tg_delete_webhook' value='1'>–£–¥–∞–ª–∏—Ç—å Webhook</button>
            <button class='btn2' name='tg_get_updates' value='1'>–ü–æ–ª—É—á–∏—Ç—å Updates</button>
          </div>

          <?php if(isset($_SESSION['tg_updates']) && is_array($_SESSION['tg_updates'])): ?>
          <div style='margin-top:8px'>
            <div class='muted mini'>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</div>
            <?php foreach(array_slice($_SESSION['tg_updates'], -5) as $u): ?>
            <?php if(isset($u['message'])): $msg=$u['message']; ?>
            <div style='background:#1a1f2b;padding:6px;margin:4px 0;border-radius:6px;font-size:12px'>
              Chat: <?=esc($msg['chat']['id'])?> | <?=esc($msg['from']['first_name']??'')?> <?=esc($msg['from']['last_name']??'')?><br>
              <?=esc(mb_substr($msg['text']??'',0,100))?>
              <form method='post' style='display:inline;margin-left:8px'>
                <input type='hidden' name='chat' value='<?=esc($msg['chat']['id'])?>'>
                <button class='btn2' name='tg_use_chat' value='1' style='padding:2px 6px;font-size:10px'>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
              </form>
            </div>
            <?php endif; ?>
            <?php endforeach; ?>
          </div>
          <?php endif; ?>
        </form>
      </div>
    </div>
  <?php endif; ?>

  <script>
    // –£–ú–ù–´–ï –ó–ê–ì–†–£–ó–ß–ò–ö–ò
    function handleFileUpload(input, dropId, formId) {
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const drop = document.getElementById(dropId);
        const form = document.getElementById(formId);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å. 10 –ú–ë)
        if (file.size > 10 * 1024 * 1024) {
          alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 10 –ú–ë.');
          input.value = '';
          return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = drop.querySelector('.drop-content');
          content.innerHTML = `
            <img src='${e.target.result}' class='drop-preview' alt='–ü—Ä–µ–≤—å—é'>
            <div class='drop-text'>–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ</div>
            <div class='drop-hint'>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>
          `;
          drop.classList.add('has-image');
        };
        reader.readAsDataURL(file);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        setTimeout(() => {
          form.submit();
        }, 500);
      }
    }

    function removeImage(dropId, type) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')) {
        const drop = document.getElementById(dropId);

        if (type === 'logo') {
          drop.querySelector('.drop-content').innerHTML = `
            <div class='drop-icon'>üñºÔ∏è</div>
            <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</div>
            <div class='drop-hint'>PNG, JPG, SVG –¥–æ 10 –ú–ë</div>
          `;
        } else {
          drop.querySelector('.drop-content').innerHTML = `
            <div class='drop-icon'>üé®</div>
            <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
            <div class='drop-hint'>PNG, JPG –¥–æ 10 –ú–ë</div>
          `;
        }

        drop.classList.remove('has-image');

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
        const form = new FormData();
        form.append('admin_save', '1');
        form.append(type === 'logo' ? 'logo' : 'hero_image', '');
        form.append(type === 'logo' ? 'logo' : 'hero_mode', type === 'logo' ? '' : 'svg');

        fetch(location.href, {
          method: 'POST',
          body: form
        }).then(() => {
          location.reload();
        });
      }
    }

    // Drag & Drop
    document.querySelectorAll('.drop').forEach(drop => {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        drop.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        drop.addEventListener(eventName, () => drop.classList.add('hover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        drop.addEventListener(eventName, () => drop.classList.remove('hover'), false);
      });

      drop.addEventListener('drop', handleDrop, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      const input = e.target.querySelector('input[type="file"]');

      if (files.length > 0) {
        input.files = files;
        const changeEvent = new Event('change', { bubbles: true });
        input.dispatchEvent(changeEvent);
      }
    }
  </script>
  </div>
  </body></html><?php exit; endif;

/* Public site */
$T = $cfg['theme'];
$cardOpacity = is_numeric($T['card_opacity']) ? max(0.3, min(1, (float)$T['card_opacity'])) : 0.65;
$blur = (int)$T['blur'];
$radius = (int)$T['radius'];
$shadow = (float)$T['shadow'];
$container = (int)$T['container'];
$muted = $T['muted'];
$bg = $T['bg'];
$text = $T['text'];
$brandCol = $T['brand'];
$accentCol = $T['accent'];

$seoTitle = $cfg['seo']['title'] ?: ($cfg['brand'] . ' ‚Äî —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è | –§–æ—Ç–æ 5 –º–∏–Ω—É—Ç');
$seoDescription = $cfg['seo']['description'] ?: ('–¢–∏–ø–æ–≥—Ä–∞—Ñ–∏—è –∏ —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä: –≤–∏–∑–∏—Ç–∫–∏, –±–∞–Ω–Ω–µ—Ä—ã, –ª–∏—Å—Ç–æ–≤–∫–∏, —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã 5 –º–∏–Ω—É—Ç. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49. –¢–µ–ª. ' . $cfg['phone_display']);
$seoKeywords = $cfg['seo']['keywords'] ?: '–ø–µ—á–∞—Ç—å, —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è, —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä, –≤–∏–∑–∏—Ç–∫–∏, –±–∞–Ω–Ω–µ—Ä—ã, —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –°–æ—Å–Ω–æ–≤—ã–π –ë–æ—Ä';
$ogImage = $cfg['seo']['og_image'] ?: ('data:image/svg+xml;base64,' . base64_encode('<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="630"><rect fill="#fff" width="100%" height="100%"/><text x="50%" y="54%" fill="#000" font-size="62" font-family="Arial,sans-serif" text-anchor="middle">'.$cfg['brand'].'</text></svg>'));
?>
<!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
  <title><?=esc($seoTitle)?></title>
  <meta name='description' content='<?=esc($seoDescription)?>'>
  <meta name='keywords' content='<?=esc($seoKeywords)?>'>
  <meta property='og:title' content='<?=esc($cfg['brand'])?>'><meta property='og:description' content='<?=esc($cfg['hero'])?>'>
  <meta property='og:type' content='website'><meta property='og:url' content='<?=esc($cfg['site'])?>'>
  <meta property='og:image' content='<?=esc($ogImage)?>'>
  <link rel='icon' href='data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27><rect width=%2764%27 height=%2764%27 rx=%2714%27 fill=%27<?=urlencode($brandCol)?>%27/><path d=%27M14 40h36v6H14zM20 18h24l6 8v14H14V26z%27 fill=%27%23000%27/></svg>'>
  <style>
    :root{
      --bg: <?=esc($bg)?>;
      --text: <?=esc($text)?>;
      --muted: <?=esc($muted)?>;
      --brand: <?=esc($brandCol)?>;
      --accent: <?=esc($accentCol)?>;
      --card: rgba(255,255,255, <?=esc(number_format($cardOpacity,2,'.',''))?>) ;
      --glass-blur: <?=esc($blur)?>px;
      --radius: <?=esc($radius)?>px;
      --shadow: 0 10px 30px rgba(0,0,0, <?=esc(number_format($shadow,2,'.',''))?>);
      --grad1: linear-gradient(135deg, <?=esc($brandCol)?>, #FFB14D);
      --grad2: linear-gradient(135deg, <?=esc($accentCol)?>, #00C2FF);
      --container: <?=esc($container)?>px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;line-height:1.5}
    body{
      background:
        radial-gradient(900px 300px at 70% -10%, rgba(45,91,255,.10), transparent 60%),
        radial-gradient(700px 280px at 20% -20%, rgba(255,138,0,.12), transparent 70%),
        var(--bg);
    }
    img{max-width:100%;height:auto;display:block}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--container);margin:0 auto;padding:0 16px}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.75);backdrop-filter:blur(var(--glass-blur)) saturate(160%);border-bottom:1px solid rgba(0,0,0,.08)}
    .topflex{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0;flex-wrap:wrap}
    .logo{display:flex;gap:12px;align-items:center;min-width:0}
    .logo-badge{width:44px;height:44px;border-radius:12px;background:var(--grad1);display:grid;place-items:center;color:#111;font-weight:900;flex:0 0 auto;overflow:hidden}
    .logo-title{font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:55vw}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav a{color:#2c4360;padding:8px 12px;border-radius:10px;font-weight:500;transition:all 0.2s}
    .nav a:hover{background:rgba(0,0,0,.08);color:#1a2b45}
    .phone a{background:var(--brand);color:#111;padding:10px 16px;border-radius:12px;font-weight:700;display:inline-block;border:2px solid rgba(0,0,0,.06);transition:all 0.2s}
    .phone a:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,138,0,.3)}
    @media(max-width:560px){.phone a{width:100%;text-align:center}}
    .hero{padding:clamp(24px,4vw,50px) 0 30px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-6{grid-column:span 6}.col-12{grid-column:span 12}
    @media(max-width:980px){.col-6{grid-column:span 12}}
    h1{font-size:clamp(26px,4vw,42px);line-height:1.2;margin:10px 0 14px;font-weight:800}
    h2{font-size:clamp(22px,3.2vw,30px);margin:0 0 14px;font-weight:700}
    p{margin:0;line-height:1.6}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:var(--card);border:1px solid rgba(0,0,0,.08);color:#7c5b00;backdrop-filter:blur(var(--glass-blur));font-weight:600;font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:12px;border:1px solid rgba(0,0,0,.1);background:var(--card);color:var(--text);font-weight:600;transition:all 0.2s;white-space:nowrap;backdrop-filter:blur(var(--glass-blur));cursor:pointer;font-size:14px;text-decoration:none}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.1)}
    .btn-primary{background:var(--grad2);border:none;color:#fff;font-weight:700}
    .btn-primary:hover{box-shadow:0 6px 25px rgba(45,91,255,.3)}
    .btn-brand{background:var(--grad1);color:#111;border:none;font-weight:700}
    .btn-brand:hover{box-shadow:0 6px 25px rgba(255,138,0,.3)}
    .btn-outline{background:rgba(255,255,255,.8);border:2px solid var(--accent);color:var(--accent);font-weight:600}
    .btn-outline:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--card);color:#31456a;border:1px solid rgba(0,0,0,.08);font-size:13px;backdrop-filter:blur(var(--glass-blur));font-weight:500}
    .muted{color:var(--muted)}
    .panel{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);backdrop-filter:blur(var(--glass-blur));box-shadow:var(--shadow)}
    .hero-media{aspect-ratio:16/10;border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);overflow:hidden;background:var(--card);backdrop-filter:blur(var(--glass-blur))}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:800px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;backdrop-filter:blur(var(--glass-blur));box-shadow:var(--shadow);transition:all 0.2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 12px 35px rgba(0,0,0,.12)}
    .card-illustr{height:120px;display:grid;place-items:center;background:linear-gradient(180deg,rgba(0,0,0,.02),transparent)}
    .card h3{margin:14px 18px 6px;font-size:clamp(16px,2.2vw,18px);font-weight:700;line-height:1.3}
    .card small{margin:0 18px 10px;color:var(--muted);display:block;line-height:1.4;font-size:13px}
    .card p{margin:0 18px 14px;color:#2b3f5f;font-weight:600;font-size:15px}
    .card .actions{margin:12px 18px 18px;display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    .card .actions .btn{padding:10px 14px;font-size:13px;font-weight:600;border-radius:10px;min-height:40px}
    .card .actions .btn-primary{background:var(--grad2);color:#fff;border:none}
    .card .actions .btn-outline{background:rgba(255,255,255,.9);border:1px solid rgba(45,91,255,.4);color:var(--accent);backdrop-filter:blur(8px)}
    .card .actions .btn-outline:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .features{padding:30px 0}
    .feature{display:flex;gap:14px;align-items:flex-start;background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);padding:16px;backdrop-filter:blur(var(--glass-blur));box-shadow:var(--shadow)}
    .steps li{margin:8px 0;line-height:1.5}
    .cta-strip{padding:24px 0;text-align:center;background:rgba(255,255,255,.75);backdrop-filter:blur(var(--glass-blur));border-block:1px solid rgba(0,0,0,.08)}
    .footer{margin-top:30px;padding:22px 0;border-top:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.7);backdrop-filter:blur(var(--glass-blur))}
    .floatactions{position:fixed;right:14px;bottom:14px;z-index:60;display:flex;flex-direction:column;gap:10px}
    .fab{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid rgba(0,0,0,.08);color:var(--text);padding:12px 14px;border-radius:14px;backdrop-filter:blur(var(--glass-blur));box-shadow:var(--shadow);transition:all 0.2s;text-decoration:none;font-weight:600}
    .fab:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
    .fab-callback{background:var(--grad1);color:#000;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    dialog{border:none;border-radius:var(--radius);padding:0;max-width:560px;width:min(560px,92%);background:var(--card);color:var(--text);backdrop-filter:blur(var(--glass-blur))}
    .modal-head{padding:16px 18px;border-bottom:1px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between}
    .modal-body{padding:18px}
    .form-row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:560px){.form-row{grid-template-columns:1fr}}
    input,select,textarea{width:100%;background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.12);padding:12px;border-radius:12px;color:#0b1a33;box-sizing:border-box;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .divider{height:1px;background:rgba(0,0,0,.08);margin:16px 0}
    .calc{padding:26px 0}
    .calc-box{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:980px){.calc-box{grid-template-columns:1fr}}
    .price-out{font-weight:800;font-size:clamp(18px,2.4vw,22px)}
    @media (max-width: 768px){.topbar{position: static; top: auto;}}
    @media (max-width: 560px){
      .nav{overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; max-width:100%}
      .nav a{flex:0 0 auto}
    }
    .payment-methods{margin:12px 0}
    .payment-option{display:flex;align-items:center;gap:10px;margin:8px 0}
    .payment-option input[type=radio]{margin:0;width:auto}
    .payment-icons{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:18px 0}
    .payment-icons svg{height:32px;width:auto;border-radius:6px;opacity:0.9}
    .payment-icons svg:hover{opacity:1;transform:scale(1.02)}
    .business-info{margin-top:18px;padding:18px;background:rgba(255,255,255,.6);border-radius:var(--radius);font-size:14px;line-height:1.5}
    .business-info .row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
    @media(max-width:600px){.business-info .row{grid-template-columns:1fr}}
    .social-links{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .social-links a{background:var(--card);padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);font-size:14px;font-weight:500;transition:all 0.2s}
    .social-links a:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin:22px 0}
    .stat-item{text-align:center;background:var(--card);padding:18px;border-radius:var(--radius);border:1px solid rgba(0,0,0,.08);backdrop-filter:blur(var(--glass-blur))}
    .stat-number{font-size:32px;font-weight:800;color:var(--brand)}
    @media(max-width:600px){.stats-grid{grid-template-columns:1fr}}

    @media (max-width: 480px) {
      .hero{padding:18px 0 22px}
      .calc-box{gap:14px}
      .grid{gap:14px}
      .fab{padding:10px 12px;font-size:14px}
    }
  </style>
</head>
<body>

<header class='topbar'>
  <div class='wrap topflex'>
    <div class='logo'>
      <div class='logo-badge'>
        <?php if (!empty($cfg['logo']) && file_exists($_SERVER['DOCUMENT_ROOT'] . $cfg['logo'])): ?>
          <img src='<?=esc($cfg['logo'])?>' alt='–õ–æ–≥–æ—Ç–∏–ø' style='width:100%;height:100%;object-fit:cover;border-radius:12px'>
        <?php else: ?>
          –ü
        <?php endif; ?>
      </div>
      <div>
        <div class='logo-title'><?=esc($cfg['brand'])?></div>
        <div class='muted' style='font-size:12px'><?=esc($cfg['slogan'])?></div>
      </div>
    </div>
   <nav class='nav' aria-label='–ù–∞–≤–∏–≥–∞—Ü–∏—è'>
  <a href='#catalog'>–ö–∞—Ç–∞–ª–æ–≥</a>
  <a href='#calc'>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
  <a href='products.php'>üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a> <!-- –ù–û–í–ê–Ø –°–°–´–õ–ö–ê -->
  <a href='https://printc47.ru/public/photoconstructor.html' target='_blank'>–§–æ—Ç–æ –æ–Ω–ª–∞–π–Ω</a>
  <a href='https://printc47.ru/public/banner_calculator.html' target='_blank'>–ö–∞–ª—å–∫. –±–∞–Ω–Ω–µ—Ä–æ–≤</a>
  <a href='#services'>–£—Å–ª—É–≥–∏</a>
  <a href='#how'>–ö–∞–∫ –∑–∞–∫–∞–∑–∞—Ç—å</a>
  <a href='#contacts'>–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
</nav>
    <div class='phone'><a href='tel:<?=esc($cfg['phone_raw'])?>'><?=esc($cfg['phone_display'])?></a></div>
  </div>
</header>

<section class='hero'>
  <div class='wrap row'>
    <div class='col-6'>
      <div class='pill'>‚ö° –ë—ã—Å—Ç—Ä–æ ‚Ä¢ –†—è–¥–æ–º ‚Ä¢ –ë–µ–∑ —Å—é—Ä–ø—Ä–∏–∑–æ–≤</div>
      <h1><?=esc($cfg['hero'])?></h1>
      <p class='muted' style='margin-bottom:14px'>–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –≤–∏–∑–∏—Ç–æ–∫, –±–∞–Ω–Ω–µ—Ä–æ–≤, –ª–∏—Å—Ç–æ–≤–æ–∫, —Å—É–≤–µ–Ω–∏—Ä–∫–∏. –ü—Ä–æ–≤–µ—Ä–∏–º –º–∞–∫–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø–æ–¥—Å–∫–∞–∂–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Å—Ä–æ–∫–∏. –û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π –∏ –ø–æ –±–µ–∑–Ω–∞–ª—É.</p>

      <div class='stats-grid'>
        <div class='stat-item'>
          <div class='stat-number'>5</div>
          <div class='muted'>–º–∏–Ω—É—Ç –Ω–∞ —Ñ–æ—Ç–æ</div>
        </div>
        <div class='stat-item'>
          <div class='stat-number'>2-4</div>
          <div class='muted'>—á–∞—Å–∞ –±–∞–Ω–Ω–µ—Ä</div>
        </div>
        <div class='stat-item'>
          <div class='stat-number'>100+</div>
          <div class='muted'>–≤–∏–¥–æ–≤ —É—Å–ª—É–≥</div>
        </div>
      </div>

      <div style='display:flex;gap:12px;flex-wrap:wrap;margin-top:16px'>
        <button class='btn btn-brand' onclick='openOrder("–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã", "–æ—Ç 400 ‚ÇΩ")'>–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –∑–∞ 5 –º–∏–Ω—É—Ç</button>
        <a class='btn btn-primary' href='#catalog'>–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥</a>
        <button class='btn' onclick='openCallback()'>üìû –û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫</button>
      </div>
      <div style='margin-top:10px;display:flex;gap:12px;flex-wrap:wrap'>
        <a class='btn btn-outline' target='_blank' href='https://printc47.ru/public/photoconstructor.html'>üñºÔ∏è –ó–∞–∫–∞–∑ —Ñ–æ—Ç–æ –æ–Ω–ª–∞–π–Ω</a>
        <a class='btn btn-outline' target='_blank' href='https://printc47.ru/public/banner_calculator.html'>üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–Ω–Ω–µ—Ä–æ–≤</a>
      </div>
      <div style='margin-top:12px' class='muted'>–ê–¥—Ä–µ—Å: <?=esc($cfg['address'])?> ‚Ä¢ –†—è–¥–æ–º: OZON –∏ ¬´–°–∞—à–∞ –°—É—à–∏¬ª</div>
      <div style='margin-top:8px;display:flex;gap:10px;flex-wrap:wrap'>
        <?php foreach($cfg['workhours'] as $w): ?><span class='badge'>üïí <?=esc($w)?></span><?php endforeach; ?>
      </div>
    </div>
    <div class='col-6'>
      <div class='hero-media'>
      <?php if ($cfg['hero_mode']==='image' && !empty($cfg['hero_image'])): ?>
        <img src='<?=esc($cfg['hero_image'])?>' alt='–§–æ—Ç–æ—Ü–µ–Ω—Ç—Ä' style='width:100%;height:100%;object-fit:cover'>
      <?php else: ?>
        <svg viewBox='0 0 640 400' width='100%' height='100%' xmlns='http://www.w3.org/2000/svg'>
          <defs>
            <linearGradient id='g1' x1='0' x2='1' y1='0' y2='1'><stop offset='0' stop-color='<?=esc($brandCol)?>'/><stop offset='1' stop-color='#FFB14D'/></linearGradient>
            <linearGradient id='g2' x1='0' x2='1' y1='1' y2='0'><stop offset='0' stop-color='<?=esc($accentCol)?>'/><stop offset='1' stop-color='#00C2FF'/></linearGradient>
          </defs>
          <rect width='640' height='400' fill='#f6f9ff'/>
          <g opacity='.25'><circle cx='520' cy='80' r='120' fill='url(#g2)'/><circle cx='120' cy='320' r='150' fill='url(#g1)'/></g>
          <g transform='translate(100,90)'><rect x='0' y='0' rx='14' width='280' height='200' fill='rgba(255,255,255,.75)' stroke='rgba(0,0,0,.08)'/><rect x='16' y='16' width='248' height='120' rx='8' fill='url(#g2)' opacity='.9'/><rect x='16' y='148' width='140' height='20' rx='6' fill='#e6eefc'/><rect x='16' y='174' width='120' height='12' rx='6' fill='#d9e5fb'/></g>
          <g transform='translate(340,110)'><rect x='0' y='0' rx='14' width='200' height='160' fill='rgba(255,255,255,.75)' stroke='rgba(0,0,0,.08)'/><circle cx='100' cy='70' r='46' fill='url(#g1)'/><rect x='40' y='130' width='120' height='12' rx='6' fill='#d9e5fb'/></g>
          <text x='50%' y='92%' text-anchor='middle' font-family='Inter,Arial' font-weight='800' font-size='22' fill='#0e1220'>–ë—ã—Å—Ç—Ä–∞—è –ø–µ—á–∞—Ç—å –∏ —Ñ–æ—Ç–æ</text>
        </svg>
      <?php endif; ?>
      </div>
    </div>
  </div>
</section>

<section id='calc' class='wrap calc'>
  <h2>–û–Ω–ª–∞–π–Ω‚Äë–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h2>
  <div class='calc-box'>
    <div class='card' style='padding:16px'>
      <h3 style='margin:0 0 12px'>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
      <div class='form-row'>
        <div><label>–¢–∏–ø –∏–∑–¥–µ–ª–∏—è<br>
          <select id='calcType'>
            <option value='cards'>–í–∏–∑–∏—Ç–∫–∏</option>
            <option value='flyers'>–õ–∏—Å—Ç–æ–≤–∫–∏</option>
            <option value='banner'>–ë–∞–Ω–Ω–µ—Ä</option>
            <option value='photo'>–§–æ—Ç–æ–ø–µ—á–∞—Ç—å</option>
            <option value='stickers'>–ù–∞–∫–ª–µ–π–∫–∏</option>
            <option value='stamps'>–®—Ç–∞–º–ø—ã</option>
          </select>
        </label></div>
        <div id='calcDynamicA'></div>
      </div>
      <div id='calcMore' class='form-row' style='margin-top:10px'></div>
      <div class='divider'></div>
      <div class='price-out'>–ò—Ç–æ–≥–æ: <span id='calcPrice'>0 ‚ÇΩ</span></div>
      <div class='muted' id='calcNote' style='margin-top:8px'></div>
      <div style='margin-top:12px;display:flex;gap:12px;flex-wrap:wrap'>
        <button class='btn btn-primary' id='calcOrder'>–ó–∞–∫–∞–∑–∞—Ç—å –ø–æ —Ä–∞—Å—á—ë—Ç—É</button>
        <button class='btn' id='calcReset'>–°–±—Ä–æ—Å</button>
        <a class='btn btn-outline' target='_blank' href='https://printc47.ru/public/banner_calculator.html'>üìê –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–Ω–Ω–µ—Ä–æ–≤</a>
      </div>
    </div>
    <div class='card' style='padding:16px'>
      <h3 style='margin:0 0 12px'>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
      <ul class='muted' style='font-size:14px;line-height:1.5'>
        <li><strong>–í–∏–∑–∏—Ç–∫–∏:</strong> –ø–µ—á–∞—Ç—å 1 –¥–µ–Ω—å, –º–µ–ª–æ–≤–∞–Ω–Ω–∞—è 300 –≥/–º¬≤, —Ç–∏—Ä–∞–∂ –æ—Ç 100 —à—Ç.</li>
        <li><strong>–õ–∏—Å—Ç–æ–≤–∫–∏:</strong> A6/A5/A4, –æ–¥–Ω–æ/–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ, —Å—Ä–æ–∫ 1-2 –¥–Ω—è.</li>
        <li><strong>–ë–∞–Ω–Ω–µ—Ä:</strong> –ü–í–• 440 –≥/–º¬≤, –ª—é–≤–µ—Ä—Å—ã, –ø—Ä–æ–≤–∞—Ä–∫–∞. –°—Ä–æ—á–Ω–æ 2‚Äì4 —á–∞—Å–∞.</li>
        <li><strong>–§–æ—Ç–æ:</strong> 10√ó15, 15√ó21, 20√ó30 ‚Äî –≥–æ—Ç–æ–≤–æ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç.</li>
        <li><strong>–ù–∞–∫–ª–µ–π–∫–∏:</strong> —Å–∞–º–æ–∫–ª–µ—è—â–∏–µ—Å—è, —Ñ–∏–≥—É—Ä–Ω–∞—è —Ä–µ–∑–∫–∞ –ø–æ –∫–æ–Ω—Ç—É—Ä—É.</li>
        <li><strong>–®—Ç–∞–º–ø—ã:</strong> –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–∞—Å—Ç–∫–∏, –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞.</li>
      </ul>
      <div class='muted' style='margin-top:10px;font-size:13px'>üí° –†–∞—Å—á–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –≤ –∑–∞—è–≤–∫—É, –º–µ–Ω–µ–¥–∂–µ—Ä —É—Ç–æ—á–Ω–∏—Ç –¥–µ—Ç–∞–ª–∏ –∏ —Å—Ä–æ–∫–∏.</div>
      <div class='divider'></div>
      <div style='display:flex;gap:10px;flex-wrap:wrap'>
        <a class='btn btn-primary' target='_blank' href='https://printc47.ru/public/photoconstructor.html'>üñºÔ∏è –ó–∞–∫–∞–∑ —Ñ–æ—Ç–æ –æ–Ω–ª–∞–π–Ω</a>
        <button class='btn' onclick='openCallback()'>üìû –ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É</button>
      </div>
    </div>
  </div>
</section>

<section id='catalog' class='wrap' style='padding:24px 0'>
  <div style='display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:10px'>
    <h2 style='margin:0'>–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥</h2>
    <span class='muted'><?=esc($cfg['catalog_desc'])?></span>
  </div>
  <div class='grid'>
    <?php
      $services = [
        ['–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã','–æ—Ç 400 ‚ÇΩ','id-card'],
        ['–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ A4/A3','–æ—Ç 20 ‚ÇΩ/–ª–∏—Å—Ç','docs'],
        ['–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫','–æ—Ç 900 ‚ÇΩ/100 —à—Ç','cards'],
        ['–ü–µ—á–∞—Ç—å –ª–∏—Å—Ç–æ–≤–æ–∫','—Ü–µ–Ω—ã —É—Ç–æ—á–Ω—è–π—Ç–µ','flyer'],
        ['–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤','–æ—Ç 1100 ‚ÇΩ','banner'],
        ['–ü–µ—á–∞—Ç—å –ø–ª–∞–∫–∞—Ç–æ–≤/–ø–æ—Å—Ç–µ—Ä–æ–≤','–æ—Ç 250 ‚ÇΩ','poster'],
        ['–ü–µ—á–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π','–æ—Ç 30 ‚ÇΩ/—à—Ç','photo'],
        ['–ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–µ–µ–∫/—Å—Ç–∏–∫–µ—Ä–æ–≤','–æ—Ç 350 ‚ÇΩ/–º¬≤','sticker'],
        ['–ü–µ—á–∞—Ç—å –Ω–∞ —Ñ—É—Ç–±–æ–ª–∫–∞—Ö','–æ—Ç 1200 ‚ÇΩ','tshirt'],
        ['–ü–µ—á–∞—Ç—å –Ω–∞ –∫—Ä—É–∂–∫–∞—Ö','–æ—Ç 600 ‚ÇΩ','mug'],
        ['–õ–∞–º–∏–Ω–∞—Ü–∏—è –∏ –±—Ä–æ—à—é—Ä–æ–≤–∫–∞','–æ—Ç 60 ‚ÇΩ','lam'],
        ['–®—Ç–∞–º–ø—ã/–ø–µ—á–∞—Ç–∏','–æ—Ç 1800 ‚ÇΩ','stamp'],
        ['–ü–µ—á–∞—Ç—å –Ω–∞ –ø–ª–µ–Ω–∫–µ','—Ü–µ–Ω—ã —É—Ç–æ—á–Ω—è–π—Ç–µ','film'],
        ['–ü—Ä–æ—è–≤–∫–∞ –ø–ª–µ–Ω–∫–∏','–±—ã—Å—Ç—Ä–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ','develop'],
        ['–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ','–æ—Ç 10 ‚ÇΩ/—Å—Ç—Ä','copy'],
        ['–ü–µ—á–∞—Ç—å –Ω–∞ —Ö–æ–ª—Å—Ç–µ','—Å—Ä–æ–∫ 1‚Äì2 –¥–Ω—è','canvas'],
      ];
      $service_info = [
        '–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã'=>'5‚Äì10 –º–∏–Ω—É—Ç. –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –î–µ—Ç—Å–∫–∞—è, —Å–µ–º–µ–π–Ω–∞—è, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã.',
        '–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ A4/A3'=>'–°—Ä–æ—á–Ω–∞—è —Ä–∞—Å–ø–µ—á–∞—Ç–∫–∞, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. –ß/–± –∏ —Ü–≤–µ—Ç–Ω–∞—è –ø–µ—á–∞—Ç—å.',
        '–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫'=>'–ú–µ–ª–æ–≤–∞–Ω–Ω–∞—è/–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è –±—É–º–∞–≥–∞, –ª–∞–º–∏–Ω–∞—Ü–∏—è, —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤. –°—Ä–æ–∫: 1 –¥–µ–Ω—å.',
        '–ü–µ—á–∞—Ç—å –ª–∏—Å—Ç–æ–≤–æ–∫'=>'A6/A5/A4, –æ–¥–Ω–æ/–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ, –±—É–º–∞–≥–∞ 130‚Äì170 –≥/–º¬≤. –¢–∏—Ä–∞–∂ –æ—Ç 100 —à—Ç.',
        '–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤'=>'–ü–í–• 440 –≥/–º¬≤, –ª—é–≤–µ—Ä—Å—ã –∏ –ø—Ä–æ–≤–∞—Ä–∫–∞ –ø–æ –∫—Ä–∞—è–º. –°—Ä–æ—á–Ω–æ –∑–∞ 2‚Äì4 —á–∞—Å–∞.',
        '–ü–µ—á–∞—Ç—å –ø–ª–∞–∫–∞—Ç–æ–≤/–ø–æ—Å—Ç–µ—Ä–æ–≤'=>'A3/A2/A1, –ø–ª–æ—Ç–Ω–∞—è –±—É–º–∞–≥–∞, —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞, –±—ã—Å—Ç—Ä—ã–µ —Å—Ä–æ–∫–∏.',
        '–ü–µ—á–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π'=>'10√ó15, 15√ó21, 20√ó30 ‚Äî –º–∞—Ç/–≥–ª—è–Ω–µ—Ü, –≥–æ—Ç–æ–≤–æ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç.',
        '–ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–µ–µ–∫/—Å—Ç–∏–∫–µ—Ä–æ–≤'=>'–°–∞–º–æ–∫–ª–µ—è—â–∞—è—Å—è –ø–ª–µ–Ω–∫–∞ –ü–í–•, —Ñ–∏–≥—É—Ä–Ω–∞—è —Ä–µ–∑–∫–∞ –ø–æ –∫–æ–Ω—Ç—É—Ä—É.',
        '–ü–µ—á–∞—Ç—å –Ω–∞ —Ñ—É—Ç–±–æ–ª–∫–∞—Ö'=>'DTF/—Ç–µ—Ä–º–æ—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä. –û—Ç 1 —à—Ç. –°—Ç–æ–π–∫–∞—è –ø–µ—á–∞—Ç—å –∏ —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞.',
        '–ü–µ—á–∞—Ç—å –Ω–∞ –∫—Ä—É–∂–∫–∞—Ö'=>'–°—É–±–ª–∏–º–∞—Ü–∏—è. –ë–µ–ª—ã–µ –∏ —Ü–≤–µ—Ç–Ω—ã–µ –∫—Ä—É–∂–∫–∏, –ø–æ–¥–∞—Ä–æ–∫ –∑–∞ 1 —á–∞—Å.',
        '–õ–∞–º–∏–Ω–∞—Ü–∏—è –∏ –±—Ä–æ—à—é—Ä–æ–≤–∫–∞'=>'–ü–∞–ø–∫–∏, –ø—Ä—É–∂–∏–Ω–∞, –ª–∞–º–∏–Ω–∞—Ü–∏—è 80‚Äì250 –º–∫–º. –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ.',
        '–®—Ç–∞–º–ø—ã/–ø–µ—á–∞—Ç–∏'=>'–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–∞—Å—Ç–∫–∏.',
        '–ü–µ—á–∞—Ç—å –Ω–∞ –ø–ª–µ–Ω–∫–µ'=>'–î–ª—è –≤–∏—Ç—Ä–∏–Ω, –∞–≤—Ç–æ –∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞. –ú–∞—Ç/–≥–ª—è–Ω–µ—Ü, –ø–ª–æ—Ç—Ç–µ—Ä–Ω–∞—è —Ä–µ–∑–∫–∞.',
        '–ü—Ä–æ—è–≤–∫–∞ –ø–ª–µ–Ω–∫–∏'=>'–ë–µ—Ä–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ.',
        '–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'=>'–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ A3, –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ e-mail/—Ç–µ–ª–µ—Ñ–æ–Ω.',
        '–ü–µ—á–∞—Ç—å –Ω–∞ —Ö–æ–ª—Å—Ç–µ'=>'–ù–∞—Ç—è–∂–∫–∞ –Ω–∞ –ø–æ–¥—Ä–∞–º–Ω–∏–∫, –ø–æ –∂–µ–ª–∞–Ω–∏—é –∑–∞—â–∏—Ç–Ω—ã–π –ª–∞–∫.'
      ];
      function icon_svg($key){
        $defs = '<defs><linearGradient id="ico" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#FF8A00"/><stop offset="1" stop-color="#FFB14D"/></linearGradient></defs>';
        $bg = '<circle cx="32" cy="32" r="30" fill="rgba(0,0,0,.04)" stroke="rgba(0,0,0,.06)" />';
        $style = 'stroke="url(#ico)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"';
        $map = [
          'id-card'=>'<rect x="14" y="18" width="36" height="28" rx="4" '.$style.'/><circle cx="24" cy="30" r="3" '.$style.'/><path d="M22 36h8" '.$style.'/><path d="M34 26h10M34 31h10M34 36h8" '.$style.'/>',
          'docs'=>'<rect x="18" y="14" width="28" height="36" rx="4" '.$style.'/><path d="M22 24h20M22 30h14M22 36h12" '.$style.'/>',
          'cards'=>'<rect x="12" y="22" width="40" height="20" rx="4" '.$style.'/><path d="M12 28h40" '.$style.'/>',
          'flyer'=>'<rect x="18" y="14" width="16" height="36" rx="3" '.$style.'/><rect x="30" y="20" width="16" height="30" rx="3" '.$style.'/>',
          'banner'=>'<rect x="12" y="20" width="40" height="16" rx="3" '.$style.'/><path d="M16 36v6M40 36v6" '.$style.'/>',
          'poster'=>'<rect x="16" y="12" width="32" height="40" rx="4" '.$style.'/><circle cx="32" cy="30" r="6" '.$style.'/>',
          'photo'=>'<rect x="12" y="16" width="40" height="32" rx="4" '.$style.'/><circle cx="26" cy="30" r="4" '.$style.'/><path d="M30 36l4-4 8 8" '.$style.'/>',
          'sticker'=>'<path d="M20 16h16a8 8 0 0 1 8 8v16H28a8 8 0 0 1-8-8V16z" '.$style.'/><path d="M44 24v16" '.$style.'/>',
          'tshirt'=>'<path d="M24 18l8-4 8 4 6-4 4 8-6 4v16a4 4 0 0 1-4 4H28a4 4 0 0 1-4-4V26l-6-4 4-8z" '.$style.'/>',
          'mug'=>'<rect x="16" y="22" width="18" height="22" rx="4" '.$style.'/><path d="M34 26h6a6 6 0 0 1 0 12h-6" '.$style.'/>',
          'lam'=>'<rect x="14" y="24" width="36" height="16" rx="4" '.$style.'/><rect x="20" y="28" width="24" height="8" rx="3" '.$style.'/>',
          'stamp'=>'<path d="M32 14a6 6 0 0 1 6 6c0 2.4-1.4 4.4-3.4 5.4L36 32H28l1.4-6.6A6 6 0 0 1 26 20a6 6 0 0 1 6-6z" '.$style.'/><rect x="18" y="34" width="28" height="6" rx="2" '.$style.'/>',
          'film'=>'<rect x="14" y="16" width="36" height="32" rx="4" '.$style.'/><path d="M24 16v32M40 16v32M14 24h36M14 32h36" '.$style.'/>',
          'develop'=>'<rect x="16" y="18" width="32" height="28" rx="4" '.$style.'/><circle cx="32" cy="32" r="6" '.$style.'/>',
          'copy'=>'<rect x="18" y="16" width="20" height="32" rx="4" '.$style.'/><rect x="28" y="20" width="20" height="28" rx="4" '.$style.'/>',
          'canvas'=>'<rect x="16" y="18" width="32" height="24" rx="3" '.$style.'/><path d="M24 18v-6M40 18v-6M22 42h20" '.$style.'/>',
          'poster2'=>'<rect x="16" y="12" width="32" height="40" rx="4" '.$style.'/>'
        ];
        $p = $map[$key] ?? $map['poster2'];
        return '<svg width="80" height="80" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">'.$defs.$bg.$p.'</svg>';
      }
    ?>
    <?php foreach($services as $s): $title=$s[0]; $price=$s[1]; $key=$s[2]; ?>
      <div class='card' data-service='<?=esc($title)?>'>
        <div class='card-illustr'><?=icon_svg($key)?></div>
        <h3><?=esc($title)?></h3>
        <small><?=esc($service_info[$title] ?? '')?></small>
        <p><?=esc($price)?></p>
        <div class='actions'>
          <button class='btn btn-primary' onclick='openOrder("<?=esc($title)?>","<?=esc($price)?>")'>–ó–∞–∫–∞–∑–∞—Ç—å</button>
          <?php if($key==='banner'): ?>
            <a class='btn btn-outline' target='_blank' href='https://printc47.ru/public/banner_calculator.html'>üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
          <?php endif; ?>
          <?php if($key==='id-card'): ?>
            <a class='btn btn-outline' target='_blank' href='https://printc47.ru/public/photoconstructor.html'>üñºÔ∏è –§–æ—Ç–æ –æ–Ω–ª–∞–π–Ω</a>
          <?php endif; ?>
          <button class='btn btn-outline' onclick='showInfo("<?=esc($title)?>')">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        </div>
      </div>
    <?php endforeach; ?>
  </div>
</section>

<section id='services' class='wrap features'>
  <div class='row'>
    <div class='col-6'>
      <div class='feature'><div>‚úÖ</div><div>
        <h3 style='margin:8px 0'>–°—Ä–æ–∫–∏ –∏ —Ü–µ–Ω—ã</h3>
        <ul class='muted'>
          <li>–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî 400 ‚ÇΩ, 5‚Äì10 –º–∏–Ω—É—Ç, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –≤–∏–¥ –±–µ—Å–ø–ª–∞—Ç–Ω–æ</li>
          <li>–ë–∞–Ω–Ω–µ—Ä—ã ‚Äî –æ—Ç 1100 ‚ÇΩ, 2‚Äì4 —á–∞—Å–∞</li>
          <li>–†–∞—Å–ø–µ—á–∞—Ç–∫–∞ ‚Äî –æ—Ç 20 ‚ÇΩ/–ª–∏—Å—Ç, —Å—Ä–∞–∑—É</li>
          <li>–§–æ—Ç–æ–ø–µ—á–∞—Ç—å ‚Äî –æ—Ç 30 ‚ÇΩ/—à—Ç, 10 –º–∏–Ω—É—Ç</li>
          <li>–í–∏–∑–∏—Ç–∫–∏/–ª–∏—Å—Ç–æ–≤–∫–∏ ‚Äî 1 –¥–µ–Ω—å</li>
          <li>–•–æ–ª—Å—Ç ‚Äî 1‚Äì2 –¥–Ω—è</li>
          <li>–®—Ç–∞–º–ø—ã ‚Äî –æ—Ç 1800 ‚ÇΩ, –æ—Ç 1 —á–∞—Å–∞</li>
        </ul></div></div>
    </div>
    <div class='col-6'>
      <div class='feature'><div>üõ†Ô∏è</div><div>
        <h3 style='margin:8px 0'>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</h3>
        <ul class='muted'>
          <li>–ü—Ä–æ–≤–µ—Ä–∏–º –º–∞–∫–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ</li>
          <li>–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</li>
          <li>–û–ø–ª–∞—Ç–∞: –∫–∞—Ä—Ç–∞, –Ω–∞–ª, –±–µ–∑–Ω–∞–ª<?=!empty($cfg['yukassa']['enabled']) ? ', –æ–Ω–ª–∞–π–Ω' : ''?></li>
          <li>–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É –∏ –†–§</li>
          <li>–°–≤—è–∑—å: —Ç–µ–ª–µ—Ñ–æ–Ω, WhatsApp, Telegram</li>
          <li>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</li>
          <li>–ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞</li>
        </ul></div></div>
    </div>
  </div>
</section>

<section id='how' class='wrap'>
  <div class='row'>
    <div class='col-6'>
      <h2>–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</h2>
      <ol class='steps'>
        <li>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏–ª–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å</li>
        <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –º–∞–∫–µ—Ç –∏–ª–∏ –∑–∞–∫–∞–∂–∏—Ç–µ –¥–∏–∑–∞–π–Ω</li>
        <li>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ü–µ–Ω—É –∏ —Å—Ä–æ–∫</li>
        <li>–ó–∞–±–µ—Ä–∏—Ç–µ –≤ —Ç–æ—á–∫–µ –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –¥–æ—Å—Ç–∞–≤–∫–∏</li>
      </ol>
      <div class='divider'></div>
      <div class='muted'>–ù–µ –Ω–∞—à–ª–∏ –Ω—É–∂–Ω–æ–µ? –ó–≤–æ–Ω–∏—Ç–µ: <a class='btn' href='tel:+79522003990'>üìû +7 (952) 200‚Äë39‚Äë90</a></div>
    </div>
    <div class='col-6'>
      <h2>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–∞–∫–µ—Ç–∞–º</h2>
      <ul class='steps'>
        <li>PDF, TIFF, PNG, JPG ‚Ä¢ CMYK ‚Ä¢ 300 dpi</li>
        <li>–í—ã–ª–µ—Ç—ã 2‚Äì3 –º–º ‚Ä¢ –¢–µ–∫—Å—Ç –≤ –∫—Ä–∏–≤—ã—Ö</li>
        <li>–ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã —É–ø–∞–∫—É–π—Ç–µ –≤ ZIP/RAR</li>
      </ul>
      <div class='divider'></div>
      <button class='btn btn-primary' onclick='openOrder("–ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç","")'>–ü–æ–ª—É—á–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç</button>
    </div>
  </div>
</section>

<section id='contacts' class='wrap' style='padding:24px 0 10px'>
  <h2>–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</h2>
  <div class='row'>
    <div class='col-6'>
      <div class='social-links'>
        <a href='tg://resolve?phone=79522003990'>üì± Telegram</a>
        <a target='_blank' href='https://wa.me/79522003990'>üíö WhatsApp</a>
        <a href='mailto:<?=esc($cfg['email_to'])?>'>‚úâÔ∏è Email</a>
        <a href='tel:+79522003990'>üìû –¢–µ–ª–µ—Ñ–æ–Ω</a>
        <?php if(!empty($cfg['social']['vk'])): ?>
          <a target='_blank' href='<?=esc($cfg['social']['vk'])?>'>üë• VK</a>
        <?php endif; ?>
        <?php if(!empty($cfg['social']['instagram'])): ?>
          <a target='_blank' href='<?=esc($cfg['social']['instagram'])?>'>üì∑ Instagram</a>
        <?php endif; ?>
      </div>
      <div class='divider'></div>
      <div class='muted'>üìç –ê–¥—Ä–µ—Å: <?=esc($cfg['address'])?></div>
      <div class='muted'>üïê –ì—Ä–∞—Ñ–∏–∫: <?=esc(implode(' ‚Ä¢ ', $cfg['workhours']))?></div>
      <div style='margin-top:12px'>
        <a class='btn' target='_blank' href='https://yandex.ru/maps/?text=<?=urlencode($cfg['address'])?>'>üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</a>
        <button class='btn btn-primary' onclick='openCallback()'>üìû –ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      </div>
    </div>
    <div class='col-6'>
      <div class='panel' style='overflow:hidden'>
        <div style='background:rgba(255,255,255,.75);backdrop-filter:blur(var(--glass-blur));padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.08);display:flex;justify-content:space-between;align-items:center'>
          <strong>–ú—ã –Ω–∞ –∫–∞—Ä—Ç–µ</strong><span class='badge'>–ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49</span>
        </div>
        <div style='height:240px;position:relative;display:grid;place-items:center'>
          <svg viewBox='0 0 600 240' width='100%' height='100%' xmlns='http://www.w3.org/2000/svg'>
            <rect width='600' height='240' rx='12' fill='#f3f7ff'/>
            <rect x='20' y='20' width='560' height='200' rx='8' fill='#ffffff' stroke='#e7edf7'/>
            <path d='M60 80h440M60 140h440' stroke='#d9e5fb' stroke-dasharray='6 6'/>
            <circle cx='160' cy='180' r='6' fill='<?=esc($brandCol)?>'/><text x='175' y='186' fill='#223660' font-size='12'>OZON</text>
            <circle cx='250' cy='100' r='6' fill='<?=esc($brandCol)?>'/><text x='265' y='106' fill='#223660' font-size='12'>¬´–°–∞—à–∞ –°—É—à–∏¬ª</text>
            <g><rect x='360' y='120' width='160' height='60' rx='8' fill='#ffffff' stroke='#d9e5fb'/><text x='440' y='155' text-anchor='middle' fill='#0e1220' font-weight='700'>–ü–†–ò–ù–¢–°–°</text><circle cx='440' cy='125' r='6' fill='#ff7a00'/></g>
          </svg>
          <a href='https://yandex.ru/maps/?text=<?=urlencode($cfg['address'])?>' target='_blank' style='position:absolute;inset:0'></a>
        </div>
      </div>
    </div>
  </div>
</section>

<footer class='footer'>
  <div class='wrap'>
    <div style='display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:space-between'>
      <div class='muted'>¬© <?=date('Y')?> <?=esc($cfg['brand'])?>. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
      <div class='muted'>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤—è–∑–∏ –ø–æ –∑–∞–∫–∞–∑—É.</div>
    </div>

    <?php if(!empty($cfg['business']['show_payment_icons'])): ?>
    <div class='payment-icons'>
      <span class='muted' style='font-size:14px;font-weight:600'>–ü—Ä–∏–Ω–∏–º–∞–µ–º –∫ –æ–ø–ª–∞—Ç–µ:</span>
      <svg width='50' height='32' viewBox='0 0 50 32' xmlns='http://www.w3.org/2000/svg'>
        <rect width='50' height='32' rx='4' fill='#1a5fb0'/>
        <rect x='8' y='12' width='10' height='8' rx='1' fill='white'/>
        <rect x='20' y='12' width='10' height='8' rx='1' fill='white'/>
        <rect x='32' y='12' width='10' height='8' rx='1' fill='white'/>
        <text x='25' y='26' text-anchor='middle' fill='white' font-size='6' font-weight='bold'>–ú–ò–†</text>
      </svg>

      <svg width='50' height='32' viewBox='0 0 50 32' xmlns='http://www.w3.org/2000/svg'>
        <rect width='50' height='32' rx='4' fill='#000'/>
        <circle cx='18' cy='16' r='8' fill='#eb001b' opacity='0.8'/>
        <circle cx='32' cy='16' r='8' fill='#f79e1b' opacity='0.8'/>
        <path d='M25 10c2 2 2 4 2 6s0 4-2 6c-2-2-2-4-2-6s0-4 2-6z' fill='#ff5f00'/>
      </svg>

      <svg width='50' height='32' viewBox='0 0 50 32' xmlns='http://www.w3.org/2000/svg'>
        <rect width='50' height='32' rx='4' fill='#1434CB'/>
        <path d='M10 12l3 8h3l3-8h-3l-1.5 5-1.5-5h-3zm8 0l-1 8h3l1-8h-3zm6 0v8h3v-3h1l1 3h3l-1-3c1-1 1-2 1-3s-1-2-2-2h-6zm10 0l-2 8h3l.5-2h2l.5 2h3l-3-8h-4z' fill='white'/>
      </svg>

      <svg width='50' height='32' viewBox='0 0 50 32' xmlns='http://www.w3.org/2000/svg'>
        <rect width='50' height='32' rx='4' fill='#FF6900'/>
        <circle cx='16' cy='16' r='6' fill='white'/>
        <circle cx='34' cy='16' r='6' fill='white'/>
        <path d='M25 10v12l-3-3m3 0l3-3' stroke='white' stroke-width='2' fill='none'/>
        <text x='25' y='26' text-anchor='middle' fill='white' font-size='5' font-weight='bold'>–°–ë–ü</text>
      </svg>

      <?php if(!empty($cfg['yukassa']['enabled'])): ?>
      <svg width='50' height='32' viewBox='0 0 50 32' xmlns='http://www.w3.org/2000/svg'>
        <rect width='50' height='32' rx='4' fill='#ffdd2d'/>
        <path d='M10 10l15 6-15 6V10zm20 2v12l-8-6 8-6z' fill='#000'/>
        <text x='25' y='26' text-anchor='middle' fill='#000' font-size='5' font-weight='bold'>–Æ–ö–∞—Å—Å–∞</text>
      </svg>
      <?php endif; ?>
    </div>
    <?php endif; ?>

    <?php if(!empty($cfg['business']['show_requisites'])): ?>
    <div class='business-info'>
      <strong><?=esc($cfg['business']['legal_name'])?></strong>
      <div class='row'>
        <?php if($cfg['business']['inn']): ?><div>–ò–ù–ù: <?=esc($cfg['business']['inn'])?></div><?php endif; ?>
        <?php if($cfg['business']['ogrn']): ?><div>–û–ì–†–ù–ò–ü: <?=esc($cfg['business']['ogrn'])?></div><?php endif; ?>
        <?php if($cfg['business']['bank']): ?><div>–ë–∞–Ω–∫: <?=esc($cfg['business']['bank'])?></div><?php endif; ?>
        <?php if($cfg['business']['bik']): ?><div>–ë–ò–ö: <?=esc($cfg['business']['bik'])?></div><?php endif; ?>
        <?php if($cfg['business']['account']): ?><div>–†/—Å: <?=esc($cfg['business']['account'])?></div><?php endif; ?>
      </div>
    </div>
    <?php endif; ?>
  </div>
</footer>

<!-- –ü–ª–∞–≤–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ -->
<div class='floatactions'>
  <a class='fab fab-callback' onclick='openCallback()'>üìû –û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫</a>
  <a class='fab' href='tel:+79522003990'>üì± <?=esc($cfg['phone_display'])?></a>
  <a class='fab' target='_blank' href='https://wa.me/79522003990'>üíö WhatsApp</a>
  <a class='fab' href='tg://resolve?phone=79522003990'>üíô Telegram</a>
</div>

<!-- Order modal -->
<dialog id='orderModal'>
  <form method='dialog'><div class='modal-head'><strong>–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑</strong><button class='btn' onclick='document.getElementById("orderModal").close();return false;'>–ó–∞–∫—Ä—ã—Ç—å ‚úï</button></div></form>
  <div class='modal-body'>
    <form id='orderForm' enctype='multipart/form-data'>
      <input type='hidden' name='mode' value='order'><input type='hidden' name='calc' id='calcHidden'>
      <div class='form-row'>
        <div><label>–í–∞—à–µ –∏–º—è<br><input required name='name' placeholder='–ò–≤–∞–Ω'></label></div>
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω<br><input required name='phone' placeholder='+7 9..'></label></div>
      </div>
      <div class='form-row'>
        <div><label>–£—Å–ª—É–≥–∞<br><input required name='service' id='orderService' placeholder='–í—ã–±—Ä–∞–Ω–æ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞/–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞'></label></div>
        <div><label>–û—Ä–∏–µ–Ω—Ç. —Ü–µ–Ω–∞<br><input name='price' id='orderPrice' placeholder='–Ω–∞–ø—Ä–∏–º–µ—Ä, 1100 ‚ÇΩ'></label></div>
      </div>
      <div><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π<br><textarea name='comment' placeholder='–¢–∏—Ä–∞–∂, —Ä–∞–∑–º–µ—Ä—ã, —Å—Ä–æ–∫–∏...'></textarea></label></div>
      <div style='margin:8px 0'><label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –º–∞–∫–µ—Ç (–¥–æ 100 –ú–ë)<input type='file' name='file' style='margin-top:8px'></label></div>

      <?php if(!empty($cfg['yukassa']['enabled'])): ?>
      <div class='payment-methods'>
        <div style='font-weight:600;margin-bottom:6px'>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
        <div class='payment-option'>
          <input type='radio' id='payment_offline' name='payment_method' value='offline' checked>
          <label for='payment_offline'>–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ (–Ω–∞–ª/–∫–∞—Ä—Ç–∞)</label>
        </div>
        <div class='payment-option'>
          <input type='radio' id='payment_online' name='payment_method' value='online'>
          <label for='payment_online'>–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ (–Æ–ö–∞—Å—Å–∞)</label>
        </div>
      </div>
      <?php endif; ?>

      <div class='divider'></div>
      <div style='display:flex;gap:12px;flex-wrap:wrap;align-items:center'>
        <button class='btn btn-primary' type='submit'>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        <span id='formStatus' class='muted'></span>
      </div>
    </form>
  </div>
</dialog>

<!-- Callback modal -->
<dialog id='callbackModal'>
  <form method='dialog'><div class='modal-head'><strong>–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫</strong><button class='btn' onclick='document.getElementById("callbackModal").close();return false;'>–ó–∞–∫—Ä—ã—Ç—å ‚úï</button></div></form>
  <div class='modal-body'>
    <form id='callbackForm'>
      <input type='hidden' name='mode' value='callback'>
      <div class='form-row'>
        <div><label>–í–∞—à–µ –∏–º—è<br><input required name='name' placeholder='–ò–≤–∞–Ω'></label></div>
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω<br><input required name='phone' placeholder='+7 9..'></label></div>
      </div>
      <div><label>–£–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–≤–æ–Ω–∫–∞<br><input name='time' placeholder='–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ 15:00' type='text'></label></div>
      <div class='muted' style='margin:12px 0;font-size:13px'>üí° –ü–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è. –ó–≤–æ–Ω–æ–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π!</div>
      <div class='divider'></div>
      <div style='display:flex;gap:12px;flex-wrap:wrap;align-items:center'>
        <button class='btn btn-primary' type='submit'>–ó–∞–∫–∞–∑–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        <span id='callbackStatus' class='muted'></span>
      </div>
    </form>
  </div>
</dialog>

<script>
  // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –°–ê–ô–¢–ê ==========
  function openOrder(service, price, calcText){
    document.getElementById('orderService').value = service || '';
    document.getElementById('orderPrice').value = price || '';
    document.getElementById('calcHidden').value = calcText || '';
    const m = document.getElementById('orderModal'); if (m.showModal) m.showModal(); else m.setAttribute('open','open');
  }

  function openCallback(){
    const m = document.getElementById('callbackModal'); if (m.showModal) m.showModal(); else m.setAttribute('open','open');
  }

  function showInfo(title){
    const info = {
      '–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã':'–§–æ—Ç–æ –∑–∞ 5‚Äì10 –º–∏–Ω—É—Ç. –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã.',
      '–ü–µ—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ A4/A3':'–°—Ä–æ—á–Ω–∞—è —Ä–∞—Å–ø–µ—á–∞—Ç–∫–∞, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. –ß/–± –∏ —Ü–≤–µ—Ç–Ω–∞—è –ø–µ—á–∞—Ç—å.',
      '–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫':'–ú–µ–ª–æ–≤–∞–Ω–Ω–∞—è/–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è –±—É–º–∞–≥–∞, –ª–∞–º–∏–Ω–∞—Ü–∏—è, —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ.',
      '–ü–µ—á–∞—Ç—å –ª–∏—Å—Ç–æ–≤–æ–∫':'A6/A5/A4, –æ–¥–Ω–æ/–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ, —Ç–∏—Ä–∞–∂ –æ—Ç 100 —à—Ç.',
      '–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤':'–ü–í–• 440 –≥/–º¬≤, –ª—é–≤–µ—Ä—Å—ã, –ø—Ä–æ–≤–∞—Ä–∫–∞. –°—Ä–æ—á–Ω–æ –∑–∞ 2‚Äì4 —á–∞—Å–∞.',
      '–ü–µ—á–∞—Ç—å –ø–ª–∞–∫–∞—Ç–æ–≤/–ø–æ—Å—Ç–µ—Ä–æ–≤':'A3/A2/A1, –ø–ª–æ—Ç–Ω–∞—è –±—É–º–∞–≥–∞, —Å–æ—á–Ω–∞—è –ø–µ—á–∞—Ç—å.',
      '–ü–µ—á–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π':'10√ó15, 15√ó21, 20√ó30 ‚Äî –º–∞—Ç/–≥–ª—è–Ω–µ—Ü.',
      '–ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–µ–µ–∫/—Å—Ç–∏–∫–µ—Ä–æ–≤':'–ü–ª–µ–Ω–∫–∞ –ü–í–•, —Ñ–∏–≥—É—Ä–Ω–∞—è —Ä–µ–∑–∫–∞.',
      '–ü–µ—á–∞—Ç—å –Ω–∞ —Ñ—É—Ç–±–æ–ª–∫–∞—Ö':'DTF/—Ç–µ—Ä–º–æ—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä. –û—Ç 1 —à—Ç.',
      '–ü–µ—á–∞—Ç—å –Ω–∞ –∫—Ä—É–∂–∫–∞—Ö':'–°—É–±–ª–∏–º–∞—Ü–∏—è, –±–µ–ª—ã–µ –∏ —Ü–≤–µ—Ç–Ω—ã–µ –∫—Ä—É–∂–∫–∏.',
      '–õ–∞–º–∏–Ω–∞—Ü–∏—è –∏ –±—Ä–æ—à—é—Ä–æ–≤–∫–∞':'–ü–∞–ø–∫–∏, –ø—Ä—É–∂–∏–Ω–∞, –ª–∞–º–∏–Ω–∞—Ü–∏—è 80‚Äì250 –º–∫–º.',
      '–®—Ç–∞–º–ø—ã/–ø–µ—á–∞—Ç–∏':'–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞.',
      '–ü–µ—á–∞—Ç—å –Ω–∞ –ø–ª–µ–Ω–∫–µ':'–î–ª—è –≤–∏—Ç—Ä–∏–Ω –∏ –∞–≤—Ç–æ, –º–∞—Ç/–≥–ª—è–Ω–µ—Ü.',
      '–ü—Ä–æ—è–≤–∫–∞ –ø–ª–µ–Ω–∫–∏':'–ë–µ—Ä–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, –±—ã—Å—Ç—Ä–æ.',
      '–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ':'–°–∫–∞–Ω –¥–æ A3, –Ω–∞ e-mail/—Ç–µ–ª–µ—Ñ–æ–Ω.',
      '–ü–µ—á–∞—Ç—å –Ω–∞ —Ö–æ–ª—Å—Ç–µ':'–ù–∞—Ç—è–∂–∫–∞ –Ω–∞ –ø–æ–¥—Ä–∞–º–Ω–∏–∫, –ø–æ –∂–µ–ª–∞–Ω–∏—é –ª–∞–∫.'
    };
    alert((title||'–£—Å–ª—É–≥–∞')+'\n\n'+(info[title]||'–ü–æ–¥—Ä–æ–±–Ω–µ–µ —É—Ç–æ—á–Ω—è–π—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.'));
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º
  document.getElementById('orderForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const st=document.getElementById('formStatus'); st.textContent='–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...'; st.className='muted';
    try{
      const data=new FormData(e.currentTarget);
      const res=await fetch(location.href,{method:'POST',body:data});
      const j=await res.json();
      st.textContent=j.message|| (j.ok?'–ì–æ—Ç–æ–≤–æ':'–û—à–∏–±–∫–∞');
      st.className=j.ok?'ok':'bad';
      if(j.ok){
        if(j.payment && j.payment_url) {
          st.textContent += ' –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ...';
          setTimeout(() => {
            window.open(j.payment_url, '_blank');
          }, 1000);
        }
        e.currentTarget.reset();
        setTimeout(()=>document.getElementById('orderModal').close(),j.payment ? 3000 : 1200);
      }
    }catch(_){ st.textContent='–°–±–æ–π —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'; st.className='bad'; }
  });

  document.getElementById('callbackForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const st=document.getElementById('callbackStatus'); st.textContent='–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...'; st.className='muted';
    try{
      const data=new FormData(e.currentTarget);
      const res=await fetch(location.href,{method:'POST',body:data});
      const j=await res.json();
      st.textContent=j.message|| (j.ok?'–ì–æ—Ç–æ–≤–æ':'–û—à–∏–±–∫–∞');
      st.className=j.ok?'ok':'bad';
      if(j.ok){
        e.currentTarget.reset();
        setTimeout(()=>document.getElementById('callbackModal').close(),1500);
      }
    }catch(_){ st.textContent='–°–±–æ–π —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'; st.className='bad'; }
  });

  // ========== –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† ==========
  const el=(s)=>document.querySelector(s);
  const q=(h)=>{const d=document.createElement('div');d.innerHTML=h.trim();return d.firstChild;}
  const rub=(n)=>new Intl.NumberFormat('ru-RU').format(Math.round(n))+' ‚ÇΩ';
  const dynA=document.getElementById('calcDynamicA'), dynMore=document.getElementById('calcMore'), note=document.getElementById('calcNote'), out=document.getElementById('calcPrice');

  function renderCalc(){
    const t=el('#calcType').value; dynA.innerHTML=''; dynMore.innerHTML=''; note.textContent=''; out.textContent='0 ‚ÇΩ';
    if(t==='cards'){
      dynA.appendChild(q(`<label>–¢–∏—Ä–∞–∂<br><select id='cc_qty'><option>100</option><option>200</option><option>500</option><option>1000</option><option>2000</option></select></label>`));
      dynMore.appendChild(q(`<div><label>–°—Ç–æ—Ä–æ–Ω—ã<br><select id='cc_side'><option value='1'>1 —Å—Ç–æ—Ä–æ–Ω–∞</option><option value='2'>2 —Å—Ç–æ—Ä–æ–Ω—ã</option></select></label></div>`));
      dynMore.appendChild(q(`<div><label>–ë—É–º–∞–≥–∞<br><select id='cc_paper'><option value='std'>–ú–µ–ª–æ–≤–∞–Ω–Ω–∞—è 300 –≥/–º¬≤</option><option value='prm'>–ü—Ä–µ–º–∏—É–º</option></select></label></div>`));
      dynMore.appendChild(q(`<div><label>–õ–∞–º–∏–Ω–∞—Ü–∏—è<br><select id='cc_lam'><option value='none'>–ù–µ—Ç</option><option value='mat'>–ú–∞—Ç–æ–≤–∞—è</option><option value='gloss'>–ì–ª—è–Ω–µ—Ü</option></select></label></div>`));
      note.textContent='–°—Ä–æ–∫: 1 –¥–µ–Ω—å. –ú–∞–∫–µ—Ç PDF/JPG, 300 dpi, –≤—ã–ª–µ—Ç—ã 2 –º–º.';
    } else if(t==='flyers'){
      dynA.appendChild(q(`<label>–§–æ—Ä–º–∞—Ç<br><select id='fl_fmt'><option value='A6'>A6</option><option value='A5'>A5</option><option value='A4'>A4</option></select></label>`));
      dynMore.appendChild(q(`<div><label>–¢–∏—Ä–∞–∂<br><input id='fl_qty' type='number' value='100' min='50' step='50'></label></div>`));
      dynMore.appendChild(q(`<div><label>–°—Ç–æ—Ä–æ–Ω—ã<br><select id='fl_side'><option value='1'>1 —Å—Ç–æ—Ä–æ–Ω–∞</option><option value='2'>2 —Å—Ç–æ—Ä–æ–Ω—ã</option></select></label></div>`));
      dynMore.appendChild(q(`<div><label>–ë—É–º–∞–≥–∞<br><select id='fl_paper'><option value='130'>130 –≥/–º¬≤</option><option value='170'>170 –≥/–º¬≤</option></select></label></div>`));
      note.textContent='–°—Ä–æ–∫: 1-2 –¥–Ω—è. –ë—É–º–∞–≥–∞ –æ—Ñ—Å–µ—Ç–Ω–∞—è/–º–µ–ª–æ–≤–∞–Ω–Ω–∞—è.';
    } else if(t==='banner'){
      dynA.appendChild(q(`<label>–®–∏—Ä–∏–Ω–∞ (–º)<br><input id='bn_w' type='number' step='0.1' value='2' min='0.3'></label>`));
      dynMore.appendChild(q(`<div><label>–í—ã—Å–æ—Ç–∞ (–º)<br><input id='bn_h' type='number' step='0.1' value='1' min='0.3'></label></div>`));
      dynMore.appendChild(q(`<div><label>–õ—é–≤–µ—Ä—Å—ã<br><select id='bn_eyes'><option value='0'>–ù–µ—Ç</option><option value='1'>–î–∞</option></select></label></div>`));
      dynMore.appendChild(q(`<div><label>–ü—Ä–æ–≤–∞—Ä–∫–∞<br><select id='bn_weld'><option value='0'>–ù–µ—Ç</option><option value='1'>–î–∞</option></select></label></div>`));
      note.textContent='–°—Ä–æ–∫: 2‚Äì4 —á–∞—Å–∞. –ü–í–•-–±–∞–Ω–Ω–µ—Ä 440 –≥/–º¬≤.';
    } else if(t==='photo'){
      dynA.appendChild(q(`<label>–†–∞–∑–º–µ—Ä<br><select id='ph_size'><option value='10x15'>10√ó15</option><option value='15x21'>15√ó21</option><option value='20x30'>20√ó30</option><option value='30x40'>30√ó40</option></select></label>`));
      dynMore.appendChild(q(`<div><label>–¢–∏—Ä–∞–∂<br><input id='ph_qty' type='number' value='10' min='1'></label></div>`));
      dynMore.appendChild(q(`<div><label>–ë—É–º–∞–≥–∞<br><select id='ph_paper'><option value='mat'>–ú–∞—Ç–æ–≤–∞—è</option><option value='gloss'>–ì–ª—è–Ω—Ü–µ–≤–∞—è</option></select></label></div>`));
      dynMore.appendChild(q(`<div><label>–°—Ä–æ—á–Ω–æ—Å—Ç—å<br><select id='ph_urgent'><option value='0'>–û–±—ã—á–Ω–æ (10 –º–∏–Ω)</option><option value='1'>–°—Ä–æ—á–Ω–æ (+50%)</option></select></label></div>`));
      note.textContent='–°—Ä–æ–∫: 10 –º–∏–Ω—É—Ç –æ–±—ã—á–Ω–æ, 5 –º–∏–Ω—É—Ç —Å—Ä–æ—á–Ω–æ.';
    } else if(t==='stickers'){
      dynA.appendChild(q(`<label>–ü–ª–æ—â–∞–¥—å (–º¬≤)<br><input id='st_area' type='number' step='0.01' value='1' min='0.01'></label>`));
      dynMore.appendChild(q(`<div><label>–¢–∏–ø –ø–ª–µ–Ω–∫–∏<br><select id='st_type'><option value='white'>–ë–µ–ª–∞—è –≥–ª—è–Ω–µ—Ü</option><option value='transparent'>–ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è</option><option value='matte'>–ë–µ–ª–∞—è –º–∞—Ç</option></select></label></div>`));
      dynMore.appendChild(q(`<div><label>–§–∏–≥—É—Ä–Ω–∞—è —Ä–µ–∑–∫–∞<br><select id='st_cut'><option value='0'>–ù–µ—Ç</option><option value='1'>–î–∞ (+30%)</option></select></label></div>`));
      note.textContent='–°—Ä–æ–∫: 1-2 –¥–Ω—è. –°–∞–º–æ–∫–ª–µ—è—â–∞—è—Å—è –ø–ª–µ–Ω–∫–∞ –ü–í–•.';
    } else if(t==='stamps'){
      dynA.appendChild(q(`<label>–¢–∏–ø —à—Ç–∞–º–ø–∞<br><select id='stamp_type'><option value='auto'>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π</option><option value='wood'>–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π</option><option value='pocket'>–ö–∞—Ä–º–∞–Ω–Ω—ã–π</option></select></label>`));
      dynMore.appendChild(q(`<div><label>–†–∞–∑–º–µ—Ä<br><select id='stamp_size'><option value='small'>–î–æ 30√ó12</option><option value='medium'>–î–æ 47√ó18</option><option value='large'>–î–æ 58√ó22</option></select></label></div>`));
      dynMore.appendChild(q(`<div><label>–°—Ä–æ—á–Ω–æ—Å—Ç—å<br><select id='stamp_urgent'><option value='0'>1-2 –¥–Ω—è</option><option value='1'>–í –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞ (+500‚ÇΩ)</option></select></label></div>`));
      note.textContent='–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ —à—Ç–∞–º–ø–æ–≤ –∏ –ø–µ—á–∞—Ç–µ–π. –û—Å–Ω–∞—Å—Ç–∫–∏ –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ.';
    }
    dynA.oninput=dynMore.oninput=calcPrice;
    calcPrice();
  }

  function calcPrice(){
    const t=el('#calcType').value; let price=0, text='';
    if(t==='cards'){
      const qty=+el('#cc_qty').value, side=+el('#cc_side').value, paper=el('#cc_paper').value, lam=el('#cc_lam').value;
      let base=900*(qty/100);
      if(side===2) base*=1.3;
      if(paper==='prm') base*=1.4;
      if(lam!=='none') base+=400*(qty/100);
      price=base;
      text=`–í–∏–∑–∏—Ç–∫–∏ ${qty} —à—Ç, ${side} —Å—Ç–æ—Ä., ${paper==='prm'?'–ø—Ä–µ–º–∏—É–º':'–º–µ–ª–æ–≤–∞–Ω–Ω–∞—è'}, –ª–∞–º–∏–Ω–∞—Ü–∏—è: ${lam==='none'?'–Ω–µ—Ç':lam}`;
    }
    if(t==='flyers'){
      const fmt=el('#fl_fmt').value, qty=Math.max(50, +el('#fl_qty').value), side=+el('#fl_side').value, paper=el('#fl_paper').value;
      let rate={'A6':3.5,'A5':5,'A4':8}[fmt]||5;
      let base=rate*qty;
      if(side===2) base*=1.6;
      if(paper==='170') base*=1.2;
      price=base;
      text=`–õ–∏—Å—Ç–æ–≤–∫–∏ ${fmt}, ${qty} —à—Ç, ${side} —Å—Ç–æ—Ä., ${paper} –≥/–º¬≤`;
    }
    if(t==='banner'){
      const w=Math.max(0.3,parseFloat(el('#bn_w').value||0)), h=Math.max(0.3,parseFloat(el('#bn_h').value||0));
      const eyes=el('#bn_eyes').value==='1', weld=el('#bn_weld').value==='1';
      const area=w*h;
      let base=Math.max(1100, area*380);
      if(eyes){ const per=Math.ceil((w*2+h*2)/0.5); base+=per*12; }
      if(weld) base+=180;
      price=base;
      text=`–ë–∞–Ω–Ω–µ—Ä ${w}√ó${h} –º${eyes?', –ª—é–≤–µ—Ä—Å—ã':''}${weld?', –ø—Ä–æ–≤–∞—Ä–∫–∞':''}`;
    }
    if(t==='photo'){
      const size=el('#ph_size').value, qty=Math.max(1,+el('#ph_qty').value), urgent=el('#ph_urgent').value==='1';
      const rate={'10x15':30,'15x21':60,'20x30':120,'30x40':200}[size]||30;
      let base=rate*qty;
      if(urgent) base*=1.5;
      price=base;
      text=`–§–æ—Ç–æ ${size}, ${qty} —à—Ç${urgent?', —Å—Ä–æ—á–Ω–æ':''}`;
    }
    if(t==='stickers'){
      const area=Math.max(0.01,parseFloat(el('#st_area').value||0)), type=el('#st_type').value, cut=el('#st_cut').value==='1';
      let rate=350;
      if(type==='transparent') rate=420;
      if(type==='matte') rate=380;
      let base=area*rate;
      if(cut) base*=1.3;
      price=base;
      text=`–ù–∞–∫–ª–µ–π–∫–∏ ${area} –º¬≤, ${type}${cut?', —Ñ–∏–≥—É—Ä–Ω–∞—è —Ä–µ–∑–∫–∞':''}`;
    }
    if(t==='stamps'){
      const type=el('#stamp_type').value, size=el('#stamp_size').value, urgent=el('#stamp_urgent').value==='1';
      let base={'auto':1800,'wood':1200,'pocket':2200}[type]||1800;
      if(size==='medium') base+=300;
      if(size==='large') base+=600;
      if(urgent) base+=500;
      price=base;
      text=`–®—Ç–∞–º–ø ${type}, ${size}${urgent?', —Å—Ä–æ—á–Ω–æ':''}`;
    }
    out.textContent=rub(price);
    document.getElementById('calcOrder').onclick=()=>openOrder('–†–∞—Å—á—ë—Ç: '+text, rub(price), text);
    document.getElementById('calcReset').onclick=()=>renderCalc();
  }

  document.getElementById('calcType').addEventListener('change', renderCalc); renderCalc();
</script>

<script type='application/ld+json'>
{"@context":"https://schema.org","@type":"CopyShop","name":"<?=esc($cfg['brand'])?>","description":"<?=esc($seoDescription)?>","address":{"@type":"PostalAddress","streetAddress":"—É–ª. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49","addressLocality":"–°–æ—Å–Ω–æ–≤—ã–π –ë–æ—Ä","addressCountry":"RU"},"telephone":"+79522003990","url":"<?=esc($cfg['site'])?>","openingHours":["Mo-Fr 10:00-20:00","Sa-Su 11:00-18:00"],"priceRange":"‚ÇΩ‚ÇΩ","paymentAccepted":["Cash","Credit Card"<?=!empty($cfg['yukassa']['enabled'])?',"Online Payment"':''?>]}
</script>
</body>
</html>
