<?php
$categories = getCategories();

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_POST['action'])) {
    $productData = [
        'name' => trim($_POST['name'] ?? ''),
        'latin_name' => trim($_POST['latin_name'] ?? ''),
        'price' => (float)($_POST['price'] ?? 0),
        'description' => trim($_POST['description'] ?? ''),
        'category_id' => (int)($_POST['category_id'] ?? 0),
        'difficulty' => trim($_POST['difficulty'] ?? '–ª–µ–≥–∫–æ'),
        'status' => 1
    ];

    if (addProduct($productData)) {
        $success = "–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!";
    } else {
        $error = "–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞";
    }
}
?>

<div class='d-flex justify-content-between align-items-center mb-4'>
    <div>
        <h1 class='mb-2'>üöÄ –ú–ï–ì–ê –°–æ–∑–¥–∞—Ç–µ–ª—å —Ç–æ–≤–∞—Ä–∞</h1>
        <p class='text-muted mb-0'>–°–æ–∑–¥–∞–π –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–π —Ç–æ–≤–∞—Ä —Å –ø–æ–º–æ—â—å—é –ò–ò –ø–æ–º–æ—â–Ω–∏–∫–∞!</p>
    </div>
    <a href='?page=products' class='btn btn-outline-primary mega-btn'>
        <i class='fas fa-arrow-left me-2'></i>–ö —Ç–æ–≤–∞—Ä–∞–º
    </a>
</div>

<?php if (isset($success)): ?>
    <div class='alert alert-success alert-dismissible fade show'>
        <i class='fas fa-check-circle me-2'></i><?= $success ?>
        <button type='button' class='btn-close' data-bs-dismiss='alert'></button>
    </div>
<?php endif; ?>

<?php if (isset($error)): ?>
    <div class='alert alert-danger alert-dismissible fade show'>
        <i class='fas fa-exclamation-triangle me-2'></i><?= $error ?>
        <button type='button' class='btn-close' data-bs-dismiss='alert'></button>
    </div>
<?php endif; ?>

<div class='row'>
    <!-- –§–æ—Ä–º–∞ —Ç–æ–≤–∞—Ä–∞ -->
    <div class='col-lg-8'>
        <div class='mega-card'>
            <div class='card-header bg-gradient-primary text-white'>
                <h5 class='mb-0'>
                    <i class='fas fa-plus-circle me-2'></i>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                </h5>
            </div>
            <div class='card-body p-4'>
                <form method='POST' id='productForm'>
                    <div class='row'>
                        <div class='col-md-8 mb-3'>
                            <label class='form-label fw-bold'>
                                <i class='fas fa-tag me-1 text-primary'></i>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *
                            </label>
                            <input type='text' class='form-control form-control-lg' name='name' id='productName' required placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω—É–±–∏–∞—Å –Ω–∞–Ω–∞'>
                        </div>
                        <div class='col-md-4 mb-3'>
                            <label class='form-label fw-bold'>
                                <i class='fas fa-ruble-sign me-1 text-success'></i>–¶–µ–Ω–∞ *
                            </label>
                            <div class='input-group'>
                                <input type='number' class='form-control form-control-lg' name='price' id='productPrice' required min='0' step='0.01' placeholder='0'>
                                <span class='input-group-text'>‚ÇΩ</span>
                                <button type='button' class='btn btn-outline-warning' onclick='aiSuggestPrice()' title='–ò–ò –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —Ü–µ–Ω—É'>
                                    <i class='fas fa-robot'></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class='mb-3'>
                        <label class='form-label fw-bold'>
                            <i class='fas fa-leaf me-1 text-info'></i>–õ–∞—Ç–∏–Ω—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        </label>
                        <input type='text' class='form-control' name='latin_name' placeholder='Anubias barteri var. nana'>
                    </div>

                    <div class='row'>
                        <div class='col-md-6 mb-3'>
                            <label class='form-label fw-bold'>
                                <i class='fas fa-list me-1 text-warning'></i>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *
                            </label>
                            <select class='form-select' name='category_id' id='productCategory' required>
                                <option value=''>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <?php foreach ($categories as $category): ?>
                                    <option value='<?= $category['id'] ?>'><?= htmlspecialchars($category['name']) ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class='col-md-6 mb-3'>
                            <label class='form-label fw-bold'>
                                <i class='fas fa-chart-line me-1 text-danger'></i>–°–ª–æ–∂–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞
                            </label>
                            <select class='form-select' name='difficulty'>
                                <option value='–ª–µ–≥–∫–æ'>üü¢ –õ–µ–≥–∫–æ</option>
                                <option value='—Å—Ä–µ–¥–Ω–µ'>üü° –°—Ä–µ–¥–Ω–µ</option>
                                <option value='—Å–ª–æ–∂–Ω–æ'>üî¥ –°–ª–æ–∂–Ω–æ</option>
                            </select>
                        </div>
                    </div>

                    <div class='mb-4'>
                        <div class='d-flex justify-content-between align-items-center mb-2'>
                            <label class='form-label fw-bold'>
                                <i class='fas fa-align-left me-1 text-secondary'></i>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *
                            </label>
                            <button type='button' class='btn btn-sm btn-outline-purple' onclick='aiGenerateDescription()'>
                                <i class='fas fa-robot me-1'></i>ü§ñ –ò–ò —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ
                            </button>
                        </div>
                        <textarea class='form-control mega-editor' name='description' id='productDescription' rows='5' placeholder='–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...' required></textarea>
                    </div>

                    <div class='text-end'>
                        <button type='reset' class='btn btn-outline-secondary me-2 mega-btn'>
                            <i class='fas fa-undo me-1'></i>–û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button type='submit' class='btn btn-success mega-btn'>
                            <i class='fas fa-save me-1'></i>üíæ –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ò–ò –ü–æ–º–æ—â–Ω–∏–∫ —Å–±–æ–∫—É -->
    <div class='col-lg-4'>
        <!-- –ò–ò –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–æ—Ç–æ -->
        <div class='mega-card mb-4'>
            <div class='card-header bg-gradient-info text-white'>
                <h6 class='mb-0'>
                    <i class='fas fa-camera me-2'></i>üé® –ú–ï–ì–ê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–æ—Ç–æ
                </h6>
            </div>
            <div class='card-body p-4'>
                <div class='photo-preview mb-3' style='height: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc;'>
                    <div class='text-center'>
                        <i class='fas fa-image fa-3x text-muted mb-2'></i>
                        <p class='text-muted mb-0'>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</p>
                    </div>
                </div>
                <button type='button' class='btn btn-info w-100 mega-btn' onclick='generatePhoto()'>
                    <i class='fas fa-magic me-1'></i>üé® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ –ò–ò
                </button>
                <small class='text-muted d-block mt-2'>–ò–ò —Å–æ–∑–¥–∞—Å—Ç —Ñ–æ—Ç–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è</small>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
        <div class='mega-card mb-4'>
            <div class='card-header bg-gradient-success text-white'>
                <h6 class='mb-0'>
                    <i class='fas fa-lightbulb me-2'></i>üí° –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                </h6>
            </div>
            <div class='card-body p-3'>
                <div class='suggestion-item mb-2' onclick='fillSuggestion("–ê–Ω—É–±–∏–∞—Å –Ω–∞–Ω–∞", "Anubias barteri var. nana", 450, 1)'>
                    <small class='fw-bold text-primary'>üåø –ê–Ω—É–±–∏–∞—Å –Ω–∞–Ω–∞</small><br>
                    <small class='text-muted'>–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –∞–∫–≤–∞—Ä–∏—É–º–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</small>
                </div>
                <div class='suggestion-item mb-2' onclick='fillSuggestion("–ù–µ–æ–Ω –≥–æ–ª—É–±–æ–π", "Paracheirodon innesi", 80, 2)'>
                    <small class='fw-bold text-info'>üê† –ù–µ–æ–Ω –≥–æ–ª—É–±–æ–π</small><br>
                    <small class='text-muted'>–Ø—Ä–∫–∞—è —Å—Ç–∞–π–Ω–∞—è —Ä—ã–±–∫–∞</small>
                </div>
                <div class='suggestion-item mb-2' onclick='fillSuggestion("–§–∏–ª—å—Ç—Ä –≤–Ω–µ—à–Ω–∏–π", "Aquael FZN-3", 2500, 3)'>
                    <small class='fw-bold text-warning'>‚öôÔ∏è –§–∏–ª—å—Ç—Ä –≤–Ω–µ—à–Ω–∏–π</small><br>
                    <small class='text-muted'>–ú–æ—â–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</small>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
        <div class='mega-card'>
            <div class='card-header bg-gradient-purple text-white'>
                <h6 class='mb-0'>
                    <i class='fas fa-eye me-2'></i>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </h6>
            </div>
            <div class='card-body p-3'>
                <div class='preview-card border rounded p-3' style='background: #f8f9fa;'>
                    <div class='preview-image mb-2' style='height: 120px; background: #e9ecef; border-radius: 8px; display: flex; align-items: center; justify-content: center;'>
                        <i class='fas fa-fish fa-2x text-muted'></i>
                    </div>
                    <h6 class='mb-1' id='previewName'>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h6>
                    <p class='small text-muted mb-2' id='previewDescription'>–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</p>
                    <div class='d-flex justify-content-between align-items-center'>
                        <strong class='text-success' id='previewPrice'>0 ‚ÇΩ</strong>
                        <small class='text-muted' id='previewCategory'>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.suggestion-item {
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.suggestion-item:hover {
    background: rgba(14, 165, 233, 0.1);
    transform: translateX(5px);
}
.btn-outline-purple {
    color: #8B5CF6;
    border-color: #8B5CF6;
}
.btn-outline-purple:hover {
    color: white;
    background-color: #8B5CF6;
}
</style>

<script>
let currentCategories = <?= json_encode($categories) ?>;

// –ò–ò –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è
async function aiGenerateDescription() {
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';
    const price = document.getElementById('productPrice').value;

    if (!name) {
        showMegaNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞!', 'warning');
        return;
    }

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É—é...';
    btn.disabled = true;

    try {
        const result = await makeRequest('ai_generate_description', {
            product_name: name,
            category: category,
            price: price
        });

        if (result.success) {
            document.getElementById('productDescription').value = result.description;
            showMegaNotification(result.message, 'success');
            updatePreview();
        } else {
            showMegaNotification(result.message, 'error');
        }
    } catch (error) {
        showMegaNotification('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// –ò–ò –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã
async function aiSuggestPrice() {
    const name = document.getElementById('productName').value;
    const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';

    if (!name) {
        showMegaNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞!', 'warning');
        return;
    }

    try {
        const result = await makeRequest('ai_suggest_price', {
            product_name: name,
            category: category
        });

        if (result.success) {
            document.getElementById('productPrice').value = result.price;
            showMegaNotification(result.message, 'success');
            updatePreview();
        } else {
            showMegaNotification(result.message, 'error');
        }
    } catch (error) {
        showMegaNotification('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ü–µ–Ω—ã', 'error');
    }
}

// –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
function fillSuggestion(name, latin, price, categoryId) {
    document.getElementById('productName').value = name;
    document.getElementById('productPrice').value = price;
    document.getElementById('productCategory').value = categoryId;

    if (latin) {
        document.querySelector('input[name="latin_name"]').value = latin;
    }

    updatePreview();
    showMegaNotification('–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞! ‚ú®', 'success');
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ –ò–ò
async function generatePhoto() {
    const name = document.getElementById('productName').value;

    if (!name) {
        showMegaNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞!', 'warning');
        return;
    }

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ–∑–¥–∞—é —Ñ–æ—Ç–æ...';
    btn.disabled = true;

    // –ò–º–∏—Ç–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ
    setTimeout(() => {
        const photoPreview = document.querySelector('.photo-preview');
        photoPreview.innerHTML = `
            <div class="text-center">
                <i class="fas fa-image fa-3x text-success mb-2"></i>
                <p class="text-success mb-0 small">–§–æ—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</p>
            </div>
        `;
        photoPreview.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';

        btn.innerHTML = originalText;
        btn.disabled = false;

        showMegaNotification('üé® –ò–ò —Å–æ–∑–¥–∞–ª –ø–æ—Ç—Ä—è—Å–∞—é—â–µ–µ —Ñ–æ—Ç–æ!', 'success');
    }, 3000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function updatePreview() {
    const name = document.getElementById('productName').value || '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞';
    const price = document.getElementById('productPrice').value || '0';
    const description = document.getElementById('productDescription').value || '–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...';
    const categoryText = document.getElementById('productCategory').selectedOptions[0]?.text || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';

    document.getElementById('previewName').textContent = name;
    document.getElementById('previewPrice').textContent = new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
    }).format(price);
    document.getElementById('previewDescription').textContent = description.substring(0, 100) + (description.length > 100 ? '...' : '');
    document.getElementById('previewCategory').textContent = categoryText;
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–æ—Ä–º—ã
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('productForm');
    const inputs = form.querySelectorAll('input, select, textarea');

    inputs.forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    updatePreview();

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
    inputs.forEach(input => {
        const savedValue = localStorage.getItem('product_' + input.name);
        if (savedValue && !input.value) {
            input.value = savedValue;
        }

        input.addEventListener('input', function() {
            localStorage.setItem('product_' + this.name, this.value);
        });
    });
});

// –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
document.querySelector('button[type="reset"]').addEventListener('click', function() {
    setTimeout(() => {
        updatePreview();
        // –û—á–∏—Å—Ç–∫–∞ localStorage
        const inputs = document.querySelectorAll('#productForm input, #productForm select, #productForm textarea');
        inputs.forEach(input => {
            localStorage.removeItem('product_' + input.name);
        });
        showMegaNotification('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞!', 'info');
    }, 100);
});
</script>
